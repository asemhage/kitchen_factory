# تطوير مراحل الإنتاج ونظام الفنيين - نظام إدارة مصنع المطابخ

## 📋 نظرة عامة

هذا المستند يحتوي على خطة تطوير شاملة لـ:
1. إعادة هيكلة مراحل الإنتاج
2. تعديل الصلاحيات والأدوار
3. نظام أرشفة الطلبيات
4. نظام إدارة الفنيين والمستحقات

---

## 🎯 الجزء الأول: تعديلات مراحل الإنتاج والصلاحيات

### 1. المراحل الجديدة (6 مراحل)

| # | اسم المرحلة | الوصف | المسؤول الرئيسي |
|---|-------------|-------|------------------|
| 1 | **تصميم** | تصميم المطبخ وإضافة المرفقات | موظف استقبال |
| 2 | **استلام العربون** | دفع العربون | **موظف استقبال** ✨ |
| 3 | **حصر المتطلبات** | تحديد المواد والتحقق من التوفر | مسؤول المخزن / مسؤول العمليات |
| 4 | **التصنيع** | الإنتاج الكامل (مرحلة واحدة) | **الفني المُكلف** + مسؤول الإنتاج |
| 5 | **التركيب** | تركيب المطبخ في موقع العميل | **الفني المُكلف** + مسؤول الإنتاج |
| 6 | **تسليم** | التسليم النهائي للعميل | مسؤول الإنتاج |

### 2. تعديلات الصلاحيات

#### أ) موظف الاستقبال
**الصلاحيات الجديدة:**
- ✅ استلام العربون (بدلاً من المحاسب)
- ✅ تسجيل الدفعة
- ✅ بدء مرحلة "حصر المتطلبات" تلقائياً

**الكود المتأثر:**
- مسار `/order/<int:order_id>/pay-deposit`
- التحقق من الصلاحية: `current_user.role in ['مدير', 'موظف استقبال']`

#### ب) مسؤول الإنتاج
**الصلاحيات الموسعة:**
- ✅ التركيب (بدلاً من مسؤول العمليات)
- ✅ التسليم النهائي
- ✅ الإشراف على الفنيين
- ✅ مراجعة واعتماد المستحقات

#### ج) مسؤول العمليات (دور شامل)
**تعريف الدور:**
- دور يجمع بين صلاحيات مسؤول المخزن + مسؤول الإنتاج
- يمكنه الوصول لجميع الميزات المتعلقة بالمخزون والإنتاج

**الصلاحيات:**
- ✅ جميع صلاحيات مسؤول المخزن
- ✅ جميع صلاحيات مسؤول الإنتاج
- ✅ حصر المتطلبات
- ✅ إدارة المواد
- ✅ إدارة الفنيين

### 3. مرحلة التصنيع - مرحلة واحدة موحدة

#### الوصف:
- **البداية:** عند بدء العمل على الطلبية (بعد حصر المتطلبات)
- **النهاية:** عند بدء مرحلة التركيب
- **المدة:** يمكن أن تستغرق عدة أيام
- **التتبع:** نسبة الإنجاز (Progress %)

#### الحقول المضافة:
```python
class Stage(db.Model):
    # ... الحقول الموجودة
    assigned_technician_id = db.Column(db.Integer, db.ForeignKey('technician.id'))  # الفني المُكلف
    technician_assigned_at = db.Column(db.DateTime)  # تاريخ التكليف
    manufacturing_start_date = db.Column(db.DateTime)  # بداية التصنيع الفعلية
    manufacturing_end_date = db.Column(db.DateTime)    # نهاية التصنيع (بداية التركيب)
```

#### سير العمل:
1. **بدء المرحلة:** مسؤول الإنتاج يُكلف فني
2. **تسجيل البداية:** الفني يُسجل بداية العمل
3. **التتبع:** تحديث نسبة الإنجاز
4. **الانتهاء:** الفني يُسجل الانتهاء → تبدأ مرحلة التركيب تلقائياً

---

## 🗄️ الجزء الثاني: نظام أرشفة الطلبيات

### 1. الهدف
- تخفيف الحمل على قاعدة البيانات الرئيسية
- الاحتفاظ بالطلبيات المكتملة للتقارير
- إمكانية الوصول للبيانات التاريخية بمرونة

### 2. الآلية

#### أ) الأرشفة التلقائية
```python
# عند إكمال مرحلة التسليم
if stage.stage_name == 'تسليم' and stage.progress == 100:
    order.status = 'مكتمل'
    order.is_archived = False  # ليس مؤرشف تلقائياً
    order.completed_at = datetime.now()
```

#### ب) الأرشفة اليدوية
- خيار في صفحة الطلبية: "أرشفة الطلبية"
- الصلاحية: المدير فقط
- الشرط: حالة الطلبية = "مكتمل"

#### ج) الأرشفة الدورية (اختياري)
- سكربت يعمل شهرياً
- يُؤرشف الطلبيات المكتملة > 6 أشهر

### 3. حقول الأرشفة

```python
class Order(db.Model):
    # ... الحقول الموجودة
    is_archived = db.Column(db.Boolean, default=False)  # هل مؤرشفة؟
    archived_at = db.Column(db.DateTime)                # تاريخ الأرشفة
    archived_by = db.Column(db.String(100))             # من قام بالأرشفة
    archive_notes = db.Column(db.Text)                  # ملاحظات الأرشفة
```

### 4. الفلترة والتقارير

#### واجهة الطلبيات
```python
# الفلتر الافتراضي: الطلبيات النشطة فقط
orders = Order.query.filter_by(is_archived=False)

# خيار: عرض المؤرشفة
if show_archived:
    orders = Order.query.filter_by(is_archived=True)

# خيار: عرض الكل
if show_all:
    orders = Order.query.all()
```

#### التقارير
- **الإيرادات:** يشمل المؤرشفة والنشطة حسب الفترة
- **الأرباح:** يشمل المؤرشفة والنشطة حسب الفترة
- **الفلاتر:**
  - الفترة الزمنية
  - الصالة
  - الحالة (مكتمل، مؤرشف، نشط)
  - نوع الطلبية

### 5. الإعدادات

#### في SystemSettings:
```python
{
    'key': 'auto_archive_enabled',
    'value': 'false',
    'description': 'تفعيل الأرشفة التلقائية للطلبيات المكتملة'
},
{
    'key': 'auto_archive_months',
    'value': '6',
    'description': 'عدد الأشهر قبل الأرشفة التلقائية'
},
{
    'key': 'show_archived_by_default',
    'value': 'false',
    'description': 'عرض الطلبيات المؤرشفة افتراضياً في القوائم'
}
```

---

## 👷 الجزء الثالث: نظام الفنيين والمستحقات

### 1. جدول الفنيين

#### النموذج (Model)
```python
class Technician(db.Model):
    __tablename__ = 'technician'
    
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(100), nullable=False)
    phone = db.Column(db.String(20))
    email = db.Column(db.String(120))
    national_id = db.Column(db.String(50))  # رقم الهوية
    
    # معلومات العمل
    specialization = db.Column(db.String(50))  # تصنيع، تركيب، كلاهما
    status = db.Column(db.String(20), default='نشط')  # نشط، متوقف، مفصول
    hire_date = db.Column(db.Date)
    
    # معلومات الحساب
    bank_name = db.Column(db.String(100))
    bank_account = db.Column(db.String(50))
    
    # الإعدادات
    payment_method = db.Column(db.String(20), default='per_meter')  # per_meter, per_order, fixed
    manufacturing_rate_per_meter = db.Column(db.Float, default=0)  # سعر متر التصنيع
    installation_rate_per_meter = db.Column(db.Float, default=0)   # سعر متر التركيب
    
    # العلاقات
    manufacturing_orders = db.relationship('Stage', 
                                          foreign_keys='Stage.manufacturing_technician_id',
                                          backref='manufacturing_technician')
    installation_orders = db.relationship('Stage',
                                         foreign_keys='Stage.installation_technician_id',
                                         backref='installation_technician')
    payments_received = db.relationship('TechnicianPayment', backref='technician')
    
    # تواريخ
    created_at = db.Column(db.DateTime, default=lambda: datetime.now(timezone.utc))
    updated_at = db.Column(db.DateTime, onupdate=lambda: datetime.now(timezone.utc))
    
    # الحسابات
    @property
    def total_dues(self):
        """إجمالي المستحقات غير المدفوعة"""
        return sum([due.amount for due in self.pending_dues])
    
    @property
    def pending_dues(self):
        """المستحقات غير المدفوعة"""
        # جلب الطلبيات المكتملة وغير المدفوعة
        return TechnicianDue.query.filter_by(
            technician_id=self.id,
            is_paid=False
        ).all()
    
    @property
    def total_paid(self):
        """إجمالي المبالغ المدفوعة"""
        return sum([payment.amount for payment in self.payments_received])
```

### 2. جدول المستحقات

```python
class TechnicianDue(db.Model):
    __tablename__ = 'technician_due'
    
    id = db.Column(db.Integer, primary_key=True)
    technician_id = db.Column(db.Integer, db.ForeignKey('technician.id'), nullable=False)
    order_id = db.Column(db.Integer, db.ForeignKey('orders.id'), nullable=False)
    stage_id = db.Column(db.Integer, db.ForeignKey('stage.id'), nullable=False)
    
    # نوع المستحق
    due_type = db.Column(db.String(20), nullable=False)  # 'manufacturing', 'installation'
    
    # التفاصيل
    meters = db.Column(db.Float)  # عدد الأمتار (إذا كان الحساب بالمتر)
    rate_per_meter = db.Column(db.Float)  # السعر لكل متر
    amount = db.Column(db.Float, nullable=False)  # المبلغ الإجمالي
    
    # الحالة
    is_paid = db.Column(db.Boolean, default=False)
    paid_at = db.Column(db.DateTime)
    payment_id = db.Column(db.Integer, db.ForeignKey('technician_payment.id'))
    
    # ملاحظات
    notes = db.Column(db.Text)
    
    # تواريخ
    created_at = db.Column(db.DateTime, default=lambda: datetime.now(timezone.utc))
    
    # العلاقات
    technician = db.relationship('Technician', backref='dues')
    order = db.relationship('Order', backref='technician_dues')
    stage = db.relationship('Stage', backref='technician_due')
```

### 3. جدول دفعات الفنيين

```python
class TechnicianPayment(db.Model):
    __tablename__ = 'technician_payment'
    
    id = db.Column(db.Integer, primary_key=True)
    technician_id = db.Column(db.Integer, db.ForeignKey('technician.id'), nullable=False)
    
    # معلومات الدفع
    amount = db.Column(db.Float, nullable=False)
    payment_date = db.Column(db.Date, nullable=False)
    payment_method = db.Column(db.String(50))  # نقداً، تحويل بنكي، شيك
    
    # التفاصيل
    reference_number = db.Column(db.String(100))  # رقم التحويل/الشيك
    notes = db.Column(db.Text)
    
    # المستحقات المُسددة
    dues_paid = db.relationship('TechnicianDue', backref='payment')
    
    # التدقيق
    paid_by = db.Column(db.String(100))  # من قام بالدفع
    created_at = db.Column(db.DateTime, default=lambda: datetime.now(timezone.utc))
```

### 4. تعديل جدول Stage

```python
class Stage(db.Model):
    # ... الحقول الموجودة
    
    # الفنيين
    manufacturing_technician_id = db.Column(db.Integer, db.ForeignKey('technician.id'))
    installation_technician_id = db.Column(db.Integer, db.ForeignKey('technician.id'))
    
    # تواريخ التكليف
    manufacturing_assigned_at = db.Column(db.DateTime)
    installation_assigned_at = db.Column(db.DateTime)
    
    # معلومات الحساب
    order_meters = db.Column(db.Float)  # عدد الأمتار للطلبية (للحساب)
```

### 5. طرق حساب المستحقات

#### أ) الحساب بالمتر (الافتراضي)
```python
def calculate_technician_due(order, stage, technician, due_type):
    """
    حساب مستحق الفني
    
    :param order: الطلبية
    :param stage: المرحلة
    :param technician: الفني
    :param due_type: نوع المستحق ('manufacturing' أو 'installation')
    :return: مبلغ المستحق
    """
    # جلب عدد الأمتار من المرحلة أو من الطلبية
    meters = stage.order_meters or order.total_meters or 0
    
    # جلب سعر المتر حسب النوع
    if due_type == 'manufacturing':
        rate = technician.manufacturing_rate_per_meter
    else:  # installation
        rate = technician.installation_rate_per_meter
    
    # الحساب
    amount = meters * rate
    
    # إنشاء سجل المستحق
    due = TechnicianDue(
        technician_id=technician.id,
        order_id=order.id,
        stage_id=stage.id,
        due_type=due_type,
        meters=meters,
        rate_per_meter=rate,
        amount=amount
    )
    
    return due
```

#### ب) طرق أخرى (مستقبلية)
- **لكل طلبية:** مبلغ ثابت لكل طلبية
- **نسبة من القيمة:** نسبة مئوية من قيمة الطلبية
- **راتب ثابت:** راتب شهري ثابت

### 6. الإعدادات العامة للفنيين

#### في SystemSettings:
```python
{
    'key': 'default_manufacturing_rate',
    'value': '50.00',
    'value_type': 'float',
    'category': 'technicians',
    'description': 'سعر المتر الافتراضي للتصنيع (د.ل)'
},
{
    'key': 'default_installation_rate',
    'value': '30.00',
    'value_type': 'float',
    'category': 'technicians',
    'description': 'سعر المتر الافتراضي للتركيب (د.ل)'
},
{
    'key': 'auto_create_dues',
    'value': 'true',
    'value_type': 'boolean',
    'category': 'technicians',
    'description': 'إنشاء المستحقات تلقائياً عند إكمال المرحلة'
}
```

### 7. واجهات المستخدم

#### أ) صفحة الفنيين (`/technicians`)
**العرض:**
- قائمة بجميع الفنيين
- البحث والفلترة (الاسم، التخصص، الحالة)
- عرض المستحقات الإجمالية لكل فني

**الأزرار:**
- إضافة فني جديد
- تعديل بيانات الفني
- عرض تفاصيل الفني

#### ب) صفحة تفاصيل الفني (`/technician/<id>`)
**الأقسام:**
1. **المعلومات الشخصية**
2. **إعدادات الحساب**
3. **المستحقات غير المدفوعة**
   - جدول بالطلبيات
   - المبلغ لكل طلبية
   - زر "دفع" لكل مستحق
4. **سجل الدفعات**
5. **إحصائيات:**
   - إجمالي المستحقات
   - إجمالي المدفوع
   - المتبقي

#### ج) صفحة دفع المستحقات (`/technician/<id>/pay`)
**الحقول:**
- اختيار المستحقات المراد دفعها (checkboxes)
- المبلغ الإجمالي (محسوب تلقائياً)
- تاريخ الدفع
- طريقة الدفع
- رقم المرجع
- ملاحظات

**الإجراء:**
1. إنشاء سجل `TechnicianPayment`
2. تحديث المستحقات المُحددة: `is_paid = True`
3. إخفاء المستحقات المدفوعة من القائمة

#### د) تكليف الفني بالمرحلة
**الموقع:** صفحة مراحل الطلبية (`/order/<id>/stages`)

**عند مرحلة التصنيع:**
- قائمة منسدلة لاختيار الفني
- زر "تكليف الفني"
- تسجيل تاريخ التكليف

**عند مرحلة التركيب:**
- قائمة منسدلة لاختيار فني التركيب
- زر "تكليف الفني"
- تسجيل تاريخ التكليف

### 8. التقارير

#### أ) تقرير مستحقات الفنيين
**المعايير:**
- الفني (محدد أو الكل)
- الفترة الزمنية
- الحالة (مدفوع، غير مدفوع، الكل)

**العرض:**
- جدول بالفنيين
- المستحقات لكل فني
- المدفوع
- المتبقي

#### ب) تقرير أداء الفنيين
**المعايير:**
- الفني
- الفترة الزمنية

**العرض:**
- عدد الطلبيات المُنجزة
- إجمالي الأمتار
- متوسط الوقت لكل طلبية
- إجمالي المستحقات

---

## 🔄 الجزء الرابع: سير العمل الكامل

### المثال الكامل: من الطلبية حتى التسليم

#### 1. التصميم
- موظف الاستقبال يُنشئ الطلبية
- إضافة المرفقات
- حالة: "قيد التصميم"

#### 2. استلام العربون
- **موظف الاستقبال** يُسجل دفع العربون
- تبدأ مرحلة "حصر المتطلبات" تلقائياً
- حالة: "قيد التنفيذ"

#### 3. حصر المتطلبات
- مسؤول المخزن / مسؤول العمليات يُحدد المواد
- استخدام نظام "إدارة المواد"
- خصم المواد المتوفرة
- تسجيل الناقص
- عند الإكمال: تبدأ مرحلة "التصنيع" تلقائياً

#### 4. التصنيع (مرحلة واحدة)
- مسؤول الإنتاج يُكلف **الفني**
- الفني يبدأ العمل (تسجيل البداية)
- تحديث نسبة الإنجاز
- الفني يُكمل العمل (تسجيل النهاية)
- **إنشاء مستحق للفني تلقائياً** (حسب الأمتار)
- تبدأ مرحلة "التركيب" تلقائياً

#### 5. التركيب
- مسؤول الإنتاج يُكلف **فني التركيب**
- الفني يبدأ التركيب
- الفني يُكمل التركيب
- **إنشاء مستحق لفني التركيب تلقائياً**
- تبدأ مرحلة "التسليم" تلقائياً

#### 6. التسليم
- مسؤول الإنتاج يُسلم المطبخ للعميل
- تسجيل التاريخ
- حالة الطلبية: "مكتمل"

#### 7. الأرشفة (اختياري)
- المدير يُؤرشف الطلبية بعد فترة
- تختفي من القوائم الافتراضية
- متاحة للتقارير عبر الفلترة

#### 8. دفع المستحقات
- مسؤول الإنتاج / المدير يعرض مستحقات الفنيين
- يختار المستحقات المراد دفعها
- يُسجل الدفعة
- تختفي الطلبيات المدفوعة من قائمة المستحقات

---

## 📊 الجزء الخامس: ملخص التعديلات التقنية

### 1. الملفات الجديدة

#### أ) نماذج البيانات (Models)
```
kitchen_factory/app.py:
- إضافة نموذج Technician
- إضافة نموذج TechnicianDue
- إضافة نموذج TechnicianPayment
- تعديل نموذج Stage (إضافة حقول الفنيين)
- تعديل نموذج Order (إضافة حقول الأرشفة)
```

#### ب) المسارات (Routes)
```
kitchen_factory/app.py:
# إدارة الفنيين
- /technicians (GET, POST) - قائمة الفنيين وإضافة جديد
- /technician/<id> (GET) - تفاصيل الفني
- /technician/<id>/edit (GET, POST) - تعديل الفني
- /technician/<id>/dues (GET) - مستحقات الفني
- /technician/<id>/pay (GET, POST) - دفع المستحقات
- /technician/<id>/deactivate (POST) - تعطيل الفني

# تكليف الفنيين
- /order/<id>/stage/<stage_id>/assign-technician (POST) - تكليف فني

# التقارير
- /reports/technician-dues - تقرير مستحقات الفنيين
- /reports/technician-performance - تقرير أداء الفنيين

# الأرشفة
- /order/<id>/archive (POST) - أرشفة طلبية
- /order/<id>/unarchive (POST) - إلغاء أرشفة
- /orders/archived (GET) - عرض المؤرشف
```

#### ج) القوالب (Templates)
```
kitchen_factory/templates/:
- technicians.html - قائمة الفنيين
- technician_detail.html - تفاصيل الفني
- new_technician.html - إضافة فني جديد
- edit_technician.html - تعديل بيانات فني
- technician_dues.html - مستحقات الفني
- pay_technician_dues.html - دفع المستحقات
- reports/technician_dues.html - تقرير المستحقات
- reports/technician_performance.html - تقرير الأداء
```

#### د) سكربتات الهجرة (Migration Scripts)
```
kitchen_factory/:
- migrate_production_stages.py - تحديث المراحل
- create_technicians_tables.py - إنشاء جداول الفنيين
- add_archive_fields.py - إضافة حقول الأرشفة
```

### 2. التعديلات على الملفات الموجودة

#### أ) app.py
```python
# السطور 1568-1574: تحديث مصفوفة المراحل
stages = [
    {"name": "تصميم", "progress": 100, "start_date": order.order_date},
    {"name": "استلام العربون", "progress": 0},
    {"name": "حصر المتطلبات", "progress": 0},
    {"name": "التصنيع", "progress": 0},
    {"name": "التركيب", "progress": 0},
    {"name": "تسليم", "progress": 0}
]

# السطور 1954-1958: تحديث منطق البدء التلقائي
requirements_stage = Stage.query.filter_by(
    order_id=order_id, 
    stage_name='حصر المتطلبات'
).first()

# مسار استلام العربون: تحديث الصلاحيات
@app.route('/order/<int:order_id>/pay-deposit', methods=['GET', 'POST'])
@login_required
def pay_deposit(order_id):
    # تغيير الصلاحية
    if current_user.role not in ['مدير', 'موظف استقبال']:  # كان 'محاسب'
        flash('ليس لديك صلاحية لهذه الصفحة', 'danger')
        return redirect(url_for('index'))
```

#### ب) order_stages.html
```html
<!-- إضافة قسم تكليف الفني -->
{% if stage.stage_name in ['التصنيع', 'التركيب'] %}
<div class="assign-technician-section">
    <label>تكليف الفني:</label>
    <select name="technician_id">
        {% for tech in technicians %}
        <option value="{{ tech.id }}">{{ tech.name }}</option>
        {% endfor %}
    </select>
    <button type="submit">تكليف</button>
</div>
{% endif %}
```

#### ج) base.html - إضافة روابط في القائمة
```html
<!-- في قائمة التنقل -->
{% if current_user.role in ['مدير', 'مسؤول إنتاج', 'مسؤول العمليات'] %}
<li class="nav-item">
    <a class="nav-link" href="{{ url_for('technicians') }}">
        <i class="fas fa-hard-hat"></i> الفنيون
    </a>
</li>
{% endif %}
```

### 3. الإعدادات الجديدة في SystemSettings

```python
# إعدادات الأرشفة
{
    'key': 'auto_archive_enabled',
    'value': 'false',
    'value_type': 'boolean',
    'category': 'orders',
    'description': 'تفعيل الأرشفة التلقائية'
},
{
    'key': 'auto_archive_months',
    'value': '6',
    'value_type': 'integer',
    'category': 'orders',
    'description': 'عدد الأشهر قبل الأرشفة التلقائية'
},

# إعدادات الفنيين
{
    'key': 'default_manufacturing_rate',
    'value': '50.00',
    'value_type': 'float',
    'category': 'technicians',
    'description': 'سعر المتر الافتراضي للتصنيع (د.ل)'
},
{
    'key': 'default_installation_rate',
    'value': '30.00',
    'value_type': 'float',
    'category': 'technicians',
    'description': 'سعر المتر الافتراضي للتركيب (د.ل)'
},
{
    'key': 'auto_create_dues',
    'value': 'true',
    'value_type': 'boolean',
    'category': 'technicians',
    'description': 'إنشاء المستحقات تلقائياً عند إكمال المرحلة'
}
```

---

## 🎯 الجزء السادس: خطة التنفيذ

### المرحلة 1: تعديلات الصلاحيات والمراحل (فورية)
**الوقت المتوقع: 1-2 ساعة**

- ✅ تحديث مصفوفة المراحل في `app.py`
- ✅ تحديث صلاحيات استلام العربون
- ✅ تحديث منطق البدء التلقائي
- ✅ إنشاء وتشغيل سكربت `migrate_production_stages.py`
- ✅ الاختبار والتحقق

### المرحلة 2: نظام الأرشفة (متوسطة الأولوية)
**الوقت المتوقع: 2-3 ساعات**

- ✅ إضافة حقول الأرشفة لنموذج `Order`
- ✅ إنشاء مسارات الأرشفة
- ✅ تحديث واجهات الطلبيات (فلاتر، أزرار)
- ✅ تحديث التقارير لدعم الفلترة
- ✅ إضافة الإعدادات
- ✅ سكربت الهجرة `add_archive_fields.py`

### المرحلة 3: نظام الفنيين - الجزء الأول (أساسي)
**الوقت المتوقع: 4-5 ساعات**

- ✅ إنشاء نماذج البيانات (Technician, TechnicianDue, TechnicianPayment)
- ✅ إنشاء سكربت الهجرة `create_technicians_tables.py`
- ✅ تعديل نموذج `Stage` (حقول الفنيين)
- ✅ إنشاء واجهات CRUD للفنيين:
  - قائمة الفنيين
  - إضافة فني
  - تعديل فني
  - تفاصيل الفني

### المرحلة 4: نظام الفنيين - الجزء الثاني (التكليف والمستحقات)
**الوقت المتوقع: 5-6 ساعات**

- ✅ تطوير واجهة تكليف الفني
- ✅ تطوير دالة حساب المستحقات
- ✅ إنشاء المستحقات تلقائياً عند الإكمال
- ✅ واجهة عرض المستحقات
- ✅ واجهة دفع المستحقات
- ✅ التحقق من اختفاء المستحقات بعد الدفع

### المرحلة 5: التقارير والإحصائيات
**الوقت المتوقع: 3-4 ساعات**

- ✅ تقرير مستحقات الفنيين
- ✅ تقرير أداء الفنيين
- ✅ إحصائيات الفنيين في Dashboard
- ✅ تحديث تقارير الإيرادات والأرباح لدعم الأرشفة

### المرحلة 6: الاختبار النهائي والتوثيق
**الوقت المتوقع: 2-3 ساعات**

- ✅ اختبار السيناريو الكامل
- ✅ التحقق من جميع الحسابات
- ✅ اختبار الأداء
- ✅ تحديث `Change log.md`
- ✅ تحديث `rules.md` (إن لزم)

---

## ⚠️ الجزء السابع: الاحتياطات والملاحظات

### 1. النسخ الاحتياطي
- **إلزامي:** نسخة احتياطية قبل كل مرحلة
- **التوقيت:** قبل تشغيل أي سكربت migration
- **الموقع:** مجلد `backups/` بتاريخ واضح

### 2. الاختبار
- **بيئة تطوير أولاً:** اختبار كامل قبل الإنتاج
- **بيانات تجريبية:** إنشاء طلبيات وفنيين للاختبار
- **السيناريوهات:**
  - طلبية كاملة من البداية للنهاية
  - تكليف فني وحساب مستحقاته
  - دفع مستحقات وإخفاؤها
  - أرشفة واستعادة طلبيات

### 3. الأداء
- **الفهرسة:** إضافة فهارس على:
  - `technician.status`
  - `technician_due.is_paid`
  - `order.is_archived`
  - `stage.manufacturing_technician_id`
  - `stage.installation_technician_id`

### 4. الأمان
- **الصلاحيات:** التحقق الدقيق من الصلاحيات في كل مسار
- **التحقق من البيانات:** validation شامل للمدخلات
- **Audit Log:** تسجيل العمليات الحساسة:
  - دفع مستحقات الفنيين
  - أرشفة الطلبيات
  - تعديل بيانات الفنيين

---

## 📈 الجزء الثامن: الفوائد المتوقعة

### 1. للإدارة
- ✅ تتبع دقيق لمراحل الإنتاج
- ✅ إدارة فعّالة للفنيين
- ✅ حسابات دقيقة للمستحقات
- ✅ تقليل الأخطاء في الحسابات
- ✅ بيانات تاريخية منظمة

### 2. للفنيين
- ✅ شفافية في المستحقات
- ✅ معرفة المبالغ المستحقة بدقة
- ✅ تتبع الدفعات

### 3. للنظام
- ✅ أداء أفضل (أرشفة البيانات القديمة)
- ✅ تقارير أسرع
- ✅ بيانات منظمة ومهيكلة
- ✅ سهولة الصيانة والتطوير

---

## 🔍 الجزء التاسع: الأسئلة الشائعة

### س1: ماذا يحدث للطلبيات القديمة؟
**ج:** يتم تحديث أسماء المراحل تلقائياً عبر سكربت الهجرة:
- "قطع" → "حصر المتطلبات"
- "تجميع" → "التصنيع"
- إضافة مرحلة "التركيب" قبل "تسليم"

### س2: هل يمكن تعديل سعر المتر لفني معين؟
**ج:** نعم، كل فني له إعدادات خاصة:
- `manufacturing_rate_per_meter`: سعر متر التصنيع
- `installation_rate_per_meter`: سعر متر التركيب

### س3: ماذا لو أخطأنا في حساب المستحق؟
**ج:** يمكن:
1. حذف المستحق قبل الدفع
2. تعديل المبلغ مباشرة في قاعدة البيانات
3. إضافة ملاحظة توضيحية

### س4: هل الأرشفة دائمة؟
**ج:** لا، يمكن إلغاء الأرشفة في أي وقت بصلاحية المدير.

### س5: كيف نتعامل مع فني يعمل على عدة طلبيات؟
**ج:** النظام يدعم ذلك:
- كل طلبية لها مستحق منفصل
- يمكن دفع مستحقات طلبيات متعددة دفعة واحدة
- يمكن دفع مستحق كل طلبية على حدة

### س6: هل يمكن للفني تسجيل الدخول للنظام؟
**ج:** في النسخة الحالية: لا.
- الفنيون ليس لهم حسابات مستخدمين
- يتم تكليفهم وإدارتهم من قبل مسؤول الإنتاج
- **تطوير مستقبلي:** يمكن إضافة حسابات للفنيين لتسجيل التقدم بأنفسهم

---

## ✅ خلاصة التطويرات

| الميزة | الوصف | الحالة | الأولوية |
|-------|------|--------|----------|
| **تعديل الصلاحيات** | نقل استلام العربون لموظف الاستقبال | 🟢 جاهز للتنفيذ | عالية جداً |
| **تعديل المراحل** | حصر المتطلبات، التصنيع، التركيب | 🟢 جاهز للتنفيذ | عالية جداً |
| **نظام الأرشفة** | أرشفة الطلبيات المكتملة | 🟡 قيد التخطيط | متوسطة |
| **نظام الفنيين** | إدارة الفنيين والمستحقات | 🟡 قيد التخطيط | عالية |
| **التقارير** | تقارير الفنيين والمستحقات | 🟡 قيد التخطيط | متوسطة |

---

**📅 تاريخ الإنشاء:** 2025-10-12  
**📝 الإصدار:** 1.0  
**✍️ المؤلف:** فريق التطوير - نظام إدارة مصنع المطابخ



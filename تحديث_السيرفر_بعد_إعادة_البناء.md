# تعليمات تحديث السيرفر - نظام الموردين الجديد

## 🎯 **الهدف**
تحديث السيرفر بالنظام الجديد لإدارة الموردين مع الدفع المرن

---

## ⚠️ **تحذير مهم جداً**

**سيتم حذف جميع بيانات الموردين والفواتير القديمة!**
- هذا آمن لأنه لا توجد بيانات إنتاج
- تأكد من وجود نسخة احتياطية

---

## 📋 **الخطوات المطلوبة**

### **الخطوة 1: تحديث الكود من GitHub**

```bash
cd ~/kitchen_factory
git pull origin main
```

**الشرح**: سحب آخر التحديثات من GitHub

---

### **الخطوة 2: إيقاف التطبيق**

```bash
# البحث عن عملية Python
ps aux | grep app.py

# إيقاف العملية (استبدل PID برقم العملية)
kill -9 PID
```

**أو إيقاف جميع عمليات Python:**

```bash
pkill -f "python.*app.py"
```

**الشرح**: إيقاف التطبيق القديم قبل الترحيل

---

### **الخطوة 3: تفعيل البيئة الافتراضية**

```bash
cd ~/kitchen_factory/kitchen_factory
source ../venv/bin/activate
```

**الشرح**: تفعيل بيئة Python المعزولة

---

### **الخطوة 4: عمل نسخة احتياطية من قاعدة البيانات**

```bash
cp instance/kitchen_factory.db instance/kitchen_factory.db.backup_before_supplier_rebuild_$(date +%Y%m%d_%H%M%S)
```

**الشرح**: نسخة احتياطية للأمان (يمكن استرجاعها إذا حدث خطأ)

---

### **الخطوة 5: تشغيل سكريبت إعادة البناء**

```bash
python migrate_supplier_system_rebuild.py
```

**ماذا سيحدث:**
1. ✅ حذف الجداول القديمة: `suppliers`, `purchase_invoices`, `purchase_invoice_items`, `supplier_payments`
2. ✅ إنشاء الجداول الجديدة: `suppliers`, `supplier_debts`, `supplier_invoices`, `supplier_payments`, `payment_allocations`
3. ✅ التحقق من البنية
4. ✅ عرض الإحصائيات

**النتيجة المتوقعة:**
```
✅ تم إكمال إعادة البناء بنجاح!
```

---

### **الخطوة 6: تشغيل التطبيق**

```bash
nohup python app.py > ~/kitchen_factory_app.log 2>&1 &
```

**الشرح**: 
- `nohup`: تشغيل في الخلفية (لا يتوقف عند إغلاق الطرفية)
- `> ~/kitchen_factory_app.log 2>&1`: حفظ السجلات
- `&`: تشغيل في الخلفية

**للتحقق من التشغيل:**
```bash
ps aux | grep app.py
```

---

### **الخطوة 7: التحقق من السجلات**

```bash
tail -f ~/kitchen_factory_app.log
```

**الخروج من المتابعة**: اضغط `Ctrl+C`

---

### **الخطوة 8: اختبار النظام**

افتح المتصفح واذهب إلى:
```
http://your-server-ip:4012
```

ثم:
1. سجل الدخول
2. اذهب إلى "إدارة الموردين"
3. أضف مورد جديد
4. أضف فاتورة
5. أضف دفعة مرنة (شاهد التوزيع التلقائي!)

---

## 🔧 **أوامر مفيدة**

### **مشاهدة حالة التطبيق:**
```bash
ps aux | grep app.py
```

### **مشاهدة السجلات الحية:**
```bash
tail -f ~/kitchen_factory_app.log
```

### **إيقاف التطبيق:**
```bash
pkill -f "python.*app.py"
```

### **إعادة تشغيل التطبيق:**
```bash
cd ~/kitchen_factory/kitchen_factory
source ../venv/bin/activate
nohup python app.py > ~/kitchen_factory_app.log 2>&1 &
```

### **التحقق من المنفذ:**
```bash
netstat -tulpn | grep 4012
# أو
lsof -i :4012
```

---

## 🆘 **حل المشاكل**

### **مشكلة 1: التطبيق لا يعمل**
```bash
# افحص السجلات
tail -50 ~/kitchen_factory_app.log

# تحقق من الأخطاء
python app.py
```

### **مشكلة 2: خطأ في قاعدة البيانات**
```bash
# استرجاع النسخة الاحتياطية
cd ~/kitchen_factory/kitchen_factory/instance
cp kitchen_factory.db kitchen_factory.db.failed
cp kitchen_factory.db.backup_before_supplier_rebuild_* kitchen_factory.db

# إعادة تشغيل الترحيل
cd ..
python migrate_supplier_system_rebuild.py
```

### **مشكلة 3: المنفذ مستخدم**
```bash
# البحث عن العملية
lsof -i :4012

# إيقاف العملية
kill -9 PID
```

---

## 📊 **التحقق من نجاح التحديث**

بعد التحديث، يجب أن تظهر:

1. ✅ صفحة "إدارة الموردين" تعمل
2. ✅ يمكنك إضافة مورد جديد
3. ✅ يمكنك إضافة فاتورة
4. ✅ زر "إضافة دفعة" يظهر في صفحة المورد
5. ✅ التوزيع التلقائي يعمل عند إضافة دفعة
6. ✅ التقارير تعمل بدون أخطاء

---

## 🎯 **ملاحظات مهمة**

1. **جميع بيانات الموردين القديمة ستُحذف** - هذا متوقع
2. **بيانات الطلبيات والصالات والمستخدمين آمنة** - لن تتأثر
3. **النظام الجديد نظيف 100%** - بدون تعقيدات النظام القديم
4. **الدفع المرن نشط** - يمكن الدفع بدون تحديد فاتورة

---

## ✅ **النتيجة المتوقعة**

**نظام موردين جديد تماماً يدعم:**
- ✅ الدفع المرن (غير مرتبط بفاتورة)
- ✅ التوزيع التلقائي (FIFO)
- ✅ تتبع دقيق للديون والمدفوعات
- ✅ واجهات محسّنة
- ✅ تقارير شاملة

---

**🎉 بالتوفيق في استخدام النظام الجديد!**


# خطة نظام الأرشفة الشامل - الجزء الثالث: الإدارة والصيانة

## 📋 نظرة عامة
هذا الجزء الثالث والأخير من خطة تطوير نظام الأرشفة الشامل، يركز على إدارة النظام، الصيانة، الواجهات، التدريب، والتشغيل طويل المدى.

---

## 🎨 المرحلة الخامسة: تطوير الواجهات الكاملة

### 📱 القوالب والواجهات

#### قالب لوحة الأرشيف الرئيسية
```html
<!-- templates/archive/dashboard.html -->
{% extends 'base.html' %}

{% block title %}لوحة الأرشيف{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <!-- عنوان الصفحة -->
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-archive"></i> لوحة إدارة الأرشيف</h2>
                <div class="btn-group">
                    <a href="{{ url_for('archive_search') }}" class="btn btn-outline-primary">
                        <i class="fas fa-search"></i> البحث المتقدم
                    </a>
                    {% if current_user.role == 'مدير' %}
                    <button type="button" class="btn btn-outline-success" onclick="triggerAutoArchive()">
                        <i class="fas fa-cogs"></i> أرشفة تلقائية
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- بطاقات الإحصائيات السريعة -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{{ stats.totals.total_archived_records }}</h4>
                            <p class="mb-0">إجمالي السجلات المؤرشفة</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-database fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{{ "%.1f"|format(stats.totals.total_size_mb) }} MB</h4>
                            <p class="mb-0">حجم الأرشيف</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-hdd fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{{ stats.totals.active_schedules }}</h4>
                            <p class="mb-0">جداول نشطة</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-calendar fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 id="pending-count">{{ get_pending_archive_count() }}</h4>
                            <p class="mb-0">في انتظار الأرشفة</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-clock fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- جداول الإحصائيات التفصيلية -->
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-table"></i> إحصائيات الجداول المؤرشفة</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>الجدول</th>
                                    <th>المؤرشف</th>
                                    <th>الحجم (MB)</th>
                                    <th>آخر أرشفة</th>
                                    <th>معدل النجاح</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for table_name, table_data in stats.tables.items() %}
                                <tr>
                                    <td>
                                        <i class="fas fa-{{ get_table_icon(table_name) }}"></i>
                                        {{ get_table_display_name(table_name) }}
                                    </td>
                                    <td>{{ table_data.total_archived }}</td>
                                    <td>{{ "%.1f"|format(table_data.total_size_mb) }}</td>
                                    <td>
                                        {% if table_data.last_archive_date %}
                                            {{ table_data.last_archive_date.strftime('%Y-%m-%d %H:%M') }}
                                        {% else %}
                                            <span class="text-muted">لا توجد</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge {% if table_data.success_rate >= 95 %}bg-success{% elif table_data.success_rate >= 80 %}bg-warning{% else %}bg-danger{% endif %}">
                                            {{ "%.1f"|format(table_data.success_rate) }}%
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{{ url_for('archived_orders' if table_name == 'orders' else 'archive_search', table_name=table_name) }}" 
                                               class="btn btn-outline-primary">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            {% if current_user.role == 'مدير' %}
                                            <button class="btn btn-outline-info" onclick="showTableStats('{{ table_name }}')">
                                                <i class="fas fa-chart-bar"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-history"></i> العمليات الأخيرة</h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        {% for operation in stats.recent_operations %}
                        <div class="timeline-item">
                            <div class="timeline-marker {% if operation.status == 'completed' %}bg-success{% elif operation.status == 'failed' %}bg-danger{% else %}bg-warning{% endif %}">
                                <i class="fas fa-{{ get_operation_icon(operation.operation_type) }}"></i>
                            </div>
                            <div class="timeline-content">
                                <h6 class="mb-1">{{ get_operation_display_name(operation.operation_type) }}</h6>
                                <p class="text-muted mb-1">
                                    {% if operation.table_name %}{{ get_table_display_name(operation.table_name) }} - {% endif %}
                                    {{ operation.record_count }} سجل
                                </p>
                                <small class="text-muted">
                                    {{ operation.operation_start.strftime('%m-%d %H:%M') }}
                                    بواسطة {{ operation.performed_by }}
                                </small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Auto Archive Confirmation -->
<div class="modal fade" id="autoArchiveModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">تأكيد الأرشفة التلقائية</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>هل أنت متأكد من تشغيل الأرشفة التلقائية؟</p>
                <p class="text-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    سيتم أرشفة جميع السجلات المؤهلة حسب الإعدادات المحددة.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <form method="POST" action="{{ url_for('trigger_auto_archive') }}" class="d-inline">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-cogs"></i> تشغيل الأرشفة
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function triggerAutoArchive() {
    const modal = new bootstrap.Modal(document.getElementById('autoArchiveModal'));
    modal.show();
}

function showTableStats(tableName) {
    // عرض إحصائيات تفصيلية للجدول
    window.open(`{{ url_for('archive_statistics') }}?table=${tableName}`, '_blank');
}

// تحديث العدادات كل دقيقة
setInterval(function() {
    fetch('/api/archive/counts')
        .then(response => response.json())
        .then(data => {
            document.getElementById('pending-count').textContent = data.pending_count;
        })
        .catch(error => console.error('Error:', error));
}, 60000);
</script>

<style>
.timeline {
    max-height: 400px;
    overflow-y: auto;
}

.timeline-item {
    display: flex;
    margin-bottom: 1rem;
}

.timeline-marker {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    flex-shrink: 0;
}

.timeline-content {
    flex: 1;
}
</style>
{% endblock %}
```

#### قالب البحث المتقدم في الأرشيف
```html
<!-- templates/archive/search.html -->
{% extends 'base.html' %}

{% block title %}البحث في الأرشيف{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2><i class="fas fa-search"></i> البحث المتقدم في الأرشيف</h2>
            
            <!-- نموذج البحث -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-filter"></i> فلاتر البحث</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('archive_search') }}">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="table_name" class="form-label">نوع البيانات</label>
                                    <select class="form-select" id="table_name" name="table_name">
                                        <option value="">جميع الأنواع</option>
                                        {% for table in available_tables %}
                                        <option value="{{ table.value }}" 
                                                {% if search_params.table_name == table.value %}selected{% endif %}>
                                            {{ table.label }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="start_date" class="form-label">من تاريخ</label>
                                    <input type="date" class="form-control" id="start_date" name="start_date" 
                                           value="{{ search_params.start_date or '' }}">
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="end_date" class="form-label">إلى تاريخ</label>
                                    <input type="date" class="form-control" id="end_date" name="end_date" 
                                           value="{{ search_params.end_date or '' }}">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="archive_reason" class="form-label">سبب الأرشفة</label>
                                    <input type="text" class="form-control" id="archive_reason" name="archive_reason" 
                                           placeholder="البحث في سبب الأرشفة..." 
                                           value="{{ search_params.archive_reason or '' }}">
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="archived_by" class="form-label">أرشف بواسطة</label>
                                    <input type="text" class="form-control" id="archived_by" name="archived_by" 
                                           placeholder="اسم المستخدم..." 
                                           value="{{ search_params.archived_by or '' }}">
                                </div>
                            </div>
                            
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label for="limit" class="form-label">عدد النتائج</label>
                                    <select class="form-select" id="limit" name="limit">
                                        <option value="50" {% if search_params.limit == 50 %}selected{% endif %}>50</option>
                                        <option value="100" {% if search_params.limit == 100 or not search_params.limit %}selected{% endif %}>100</option>
                                        <option value="200" {% if search_params.limit == 200 %}selected{% endif %}>200</option>
                                        <option value="500" {% if search_params.limit == 500 %}selected{% endif %}>500</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search"></i> بحث
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                                    <i class="fas fa-undo"></i> إعادة تعيين
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- نتائج البحث -->
            {% if results %}
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-list"></i> نتائج البحث ({{ results|length }} نتيجة)</h5>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-success" onclick="exportResults()">
                            <i class="fas fa-download"></i> تصدير
                        </button>
                        {% if current_user.role == 'مدير' %}
                        <button class="btn btn-outline-info" onclick="bulkRestore()">
                            <i class="fas fa-undo"></i> استعادة متعددة
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="resultsTable">
                            <thead>
                                <tr>
                                    <th>
                                        <input type="checkbox" id="selectAll" onchange="toggleAll(this)">
                                    </th>
                                    <th>النوع</th>
                                    <th>معرف السجل</th>
                                    <th>تاريخ الأرشفة</th>
                                    <th>بواسطة</th>
                                    <th>السبب</th>
                                    <th>الحجم</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for result in results %}
                                <tr>
                                    <td>
                                        <input type="checkbox" name="selected_records" 
                                               value="{{ result.source_table }}:{{ result.source_id }}"
                                               class="record-checkbox">
                                    </td>
                                    <td>
                                        <span class="badge bg-info">
                                            {{ get_table_display_name(result.source_table) }}
                                        </span>
                                    </td>
                                    <td>{{ result.source_id }}</td>
                                    <td>{{ result.archived_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                    <td>{{ result.archived_by }}</td>
                                    <td>
                                        <span class="text-muted" title="{{ result.archive_reason or 'غير محدد' }}">
                                            {{ (result.archive_reason or 'غير محدد')[:30] }}{% if (result.archive_reason or '')|length > 30 %}...{% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        {% if result.data_size_bytes %}
                                            {{ "%.1f"|format(result.data_size_bytes / 1024) }} KB
                                        {% else %}
                                            <span class="text-muted">غير محدد</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" 
                                                    onclick="viewDetails('{{ result.source_table }}', {{ result.source_id }})">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            {% if current_user.role == 'مدير' and result.can_restore %}
                                            <button class="btn btn-outline-success" 
                                                    onclick="confirmRestore('{{ result.source_table }}', {{ result.source_id }})">
                                                <i class="fas fa-undo"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% elif search_params %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> لم يتم العثور على نتائج مطابقة لمعايير البحث.
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal for Record Details -->
<div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">تفاصيل السجل المؤرشف</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="recordDetails">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">جاري التحميل...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Restore Confirmation -->
<div class="modal fade" id="restoreModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">تأكيد الاستعادة</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="restoreForm" method="POST">
                    <p>هل أنت متأكد من استعادة هذا السجل من الأرشيف؟</p>
                    <div class="mb-3">
                        <label for="restore_reason" class="form-label">سبب الاستعادة</label>
                        <textarea class="form-control" id="restore_reason" name="restore_reason" rows="3" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="submit" form="restoreForm" class="btn btn-success">
                    <i class="fas fa-undo"></i> استعادة
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function resetForm() {
    document.getElementById('table_name').value = '';
    document.getElementById('start_date').value = '';
    document.getElementById('end_date').value = '';
    document.getElementById('archive_reason').value = '';
    document.getElementById('archived_by').value = '';
    document.getElementById('limit').value = '100';
}

function toggleAll(checkbox) {
    const checkboxes = document.querySelectorAll('.record-checkbox');
    checkboxes.forEach(cb => cb.checked = checkbox.checked);
}

function viewDetails(tableName, recordId) {
    const modal = new bootstrap.Modal(document.getElementById('detailsModal'));
    
    // جلب تفاصيل السجل عبر AJAX
    fetch(`/api/archive/details/${tableName}/${recordId}`)
        .then(response => response.json())
        .then(data => {
            let html = '<div class="row">';
            
            // معلومات الأرشفة
            html += '<div class="col-md-6"><h6>معلومات الأرشفة</h6>';
            html += `<p><strong>تاريخ الأرشفة:</strong> ${data.archived_at}</p>`;
            html += `<p><strong>بواسطة:</strong> ${data.archived_by}</p>`;
            html += `<p><strong>السبب:</strong> ${data.archive_reason || 'غير محدد'}</p>`;
            html += `<p><strong>النوع:</strong> ${data.archive_type}</p>`;
            html += '</div>';
            
            // البيانات الأصلية
            html += '<div class="col-md-6"><h6>البيانات الأصلية</h6>';
            if (data.original_data) {
                html += '<pre class="bg-light p-2" style="max-height: 300px; overflow-y: auto;">';
                html += JSON.stringify(data.original_data, null, 2);
                html += '</pre>';
            } else {
                html += '<p class="text-muted">البيانات الأصلية غير متاحة</p>';
            }
            html += '</div></div>';
            
            document.getElementById('recordDetails').innerHTML = html;
            modal.show();
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('recordDetails').innerHTML = 
                '<div class="alert alert-danger">حدث خطأ في تحميل البيانات</div>';
            modal.show();
        });
}

function confirmRestore(tableName, recordId) {
    const form = document.getElementById('restoreForm');
    form.action = `/archive/restore/${tableName}/${recordId}`;
    
    const modal = new bootstrap.Modal(document.getElementById('restoreModal'));
    modal.show();
}

function exportResults() {
    // تصدير النتائج إلى Excel أو CSV
    const table = document.getElementById('resultsTable');
    // تنفيذ تصدير البيانات
    alert('سيتم تنفيذ التصدير قريباً');
}

function bulkRestore() {
    const selected = document.querySelectorAll('.record-checkbox:checked');
    if (selected.length === 0) {
        alert('يرجى اختيار سجل واحد على الأقل');
        return;
    }
    
    if (confirm(`هل أنت متأكد من استعادة ${selected.length} سجل؟`)) {
        // تنفيذ الاستعادة الجماعية
        alert('سيتم تنفيذ الاستعادة الجماعية قريباً');
    }
}
</script>
{% endblock %}
```

---

## ⚙️ المرحلة السادسة: النظم المساعدة والأتمتة

### 🤖 نظام الجدولة التلقائية

#### إنشاء نظام Cron للأرشفة التلقائية
```python
# archive_scheduler.py - نظام جدولة الأرشفة التلقائية

import schedule
import time
import threading
import logging
from datetime import datetime, timedelta
from typing import Dict, List, Any

class ArchiveScheduler:
    """نظام جدولة الأرشفة التلقائية"""
    
    def __init__(self, app):
        self.app = app
        self.logger = logging.getLogger('archive_scheduler')
        self.running = False
        self.scheduler_thread = None
    
    def start(self):
        """بدء تشغيل النظام"""
        if self.running:
            self.logger.warning("نظام الجدولة يعمل بالفعل")
            return
        
        self.running = True
        self.setup_schedules()
        
        # تشغيل النظام في خيط منفصل
        self.scheduler_thread = threading.Thread(target=self._run_scheduler, daemon=True)
        self.scheduler_thread.start()
        
        self.logger.info("تم بدء تشغيل نظام جدولة الأرشفة")
    
    def stop(self):
        """إيقاف النظام"""
        self.running = False
        schedule.clear()
        self.logger.info("تم إيقاف نظام جدولة الأرشفة")
    
    def setup_schedules(self):
        """إعداد الجداول الزمنية للأرشفة"""
        
        with self.app.app_context():
            # جدولة الأرشفة اليومية
            daily_time = get_archive_setting('archive_daily_maintenance_time', '02:00', 'string')
            schedule.every().day.at(daily_time).do(self.daily_archive_maintenance)
            
            # جدولة الصيانة الأسبوعية
            schedule.every().sunday.at("01:00").do(self.weekly_maintenance)
            
            # جدولة التحقق من النظام كل ساعة
            schedule.every().hour.do(self.hourly_health_check)
            
            # تحديث الإحصائيات كل 6 ساعات
            schedule.every(6).hours.do(self.update_statistics)
            
            self.logger.info("تم إعداد جداول الأرشفة التلقائية")
    
    def _run_scheduler(self):
        """تشغيل النظام في خيط منفصل"""
        while self.running:
            try:
                schedule.run_pending()
                time.sleep(60)  # فحص كل دقيقة
            except Exception as e:
                self.logger.error(f"خطأ في نظام الجدولة: {str(e)}")
                time.sleep(300)  # انتظار 5 دقائق في حالة الخطأ
    
    def daily_archive_maintenance(self):
        """صيانة الأرشفة اليومية"""
        try:
            with self.app.app_context():
                self.logger.info("بدء الصيانة اليومية للأرشفة")
                
                # تشغيل الأرشفة التلقائية
                results = auto_archive_eligible_records()
                
                # تنظيف السجلات القديمة
                self.cleanup_old_logs()
                
                # تحديث الإحصائيات
                self.update_all_statistics()
                
                # إرسال تقرير يومي
                self.send_daily_report(results)
                
                self.logger.info("اكتملت الصيانة اليومية للأرشفة")
                
        except Exception as e:
            self.logger.error(f"خطأ في الصيانة اليومية: {str(e)}")
    
    def weekly_maintenance(self):
        """صيانة أسبوعية شاملة"""
        try:
            with self.app.app_context():
                self.logger.info("بدء الصيانة الأسبوعية للأرشفة")
                
                # تحسين قاعدة بيانات الأرشيف
                self.optimize_archive_database()
                
                # التحقق من سلامة البيانات
                integrity_results = self.verify_archive_integrity()
                
                # تنظيف الملفات المؤقتة
                self.cleanup_temp_files()
                
                # إنشاء نسخ احتياطية
                if get_archive_setting('archive_backup_enabled', True, 'boolean'):
                    self.create_archive_backup()
                
                # إرسال تقرير أسبوعي
                self.send_weekly_report(integrity_results)
                
                self.logger.info("اكتملت الصيانة الأسبوعية للأرشفة")
                
        except Exception as e:
            self.logger.error(f"خطأ في الصيانة الأسبوعية: {str(e)}")
    
    def hourly_health_check(self):
        """فحص سلامة النظام كل ساعة"""
        try:
            with self.app.app_context():
                # فحص حجم قاعدة البيانات
                db_size = self.get_archive_database_size()
                max_size = get_archive_setting('archive_max_size_gb', 10, 'float') * 1024  # MB
                
                if db_size > max_size:
                    self.logger.warning(f"حجم قاعدة بيانات الأرشيف ({db_size:.1f} MB) يتجاوز الحد المسموح")
                
                # فحص العمليات المعلقة
                stuck_operations = self.check_stuck_operations()
                if stuck_operations:
                    self.logger.warning(f"توجد {len(stuck_operations)} عمليات معلقة")
                
                # فحص مساحة التخزين
                self.check_storage_space()
                
        except Exception as e:
            self.logger.error(f"خطأ في فحص سلامة النظام: {str(e)}")
    
    def update_statistics(self):
        """تحديث إحصائيات الأرشيف"""
        try:
            with self.app.app_context():
                # تحديث إحصائيات جميع الجداول
                tables = ['orders', 'purchase_invoice', 'technician_due', 'audit_log', 'material_consumption']
                
                for table in tables:
                    self.update_table_statistics(table)
                
                self.logger.info("تم تحديث إحصائيات الأرشيف")
                
        except Exception as e:
            self.logger.error(f"خطأ في تحديث الإحصائيات: {str(e)}")
    
    def cleanup_old_logs(self):
        """تنظيف سجلات العمليات القديمة"""
        try:
            # حذف سجلات أقدم من 90 يوم
            cutoff_date = datetime.utcnow() - timedelta(days=90)
            
            deleted_count = db.session.execute(
                "DELETE FROM archive_operations_log WHERE operation_start < %s",
                [cutoff_date]
            ).rowcount
            
            db.session.commit()
            
            if deleted_count > 0:
                self.logger.info(f"تم حذف {deleted_count} سجل عملية قديم")
                
        except Exception as e:
            self.logger.error(f"خطأ في تنظيف السجلات القديمة: {str(e)}")
    
    def verify_archive_integrity(self) -> Dict[str, Any]:
        """التحقق من سلامة بيانات الأرشيف"""
        results = {
            'total_checked': 0,
            'corrupted_records': [],
            'missing_relationships': [],
            'checksum_mismatches': []
        }
        
        try:
            # فحص عينة من السجلات المؤرشفة
            sample_records = ArchiveMetadata.query.filter(
                ArchiveMetadata.checksum.isnot(None)
            ).order_by(db.func.random()).limit(100).all()
            
            results['total_checked'] = len(sample_records)
            
            for record in sample_records:
                # التحقق من checksum
                if record.original_record_json:
                    original_data = json.loads(record.original_record_json)
                    calculated_checksum = calculate_data_checksum(original_data)
                    
                    if calculated_checksum != record.checksum:
                        results['checksum_mismatches'].append(record.id)
                
                # التحقق من وجود العلاقات
                expected_relationships = ArchiveRelationship.query.filter_by(
                    archive_batch_id=record.id
                ).count()
                
                if expected_relationships == 0 and record.source_table in ['orders', 'purchase_invoice']:
                    results['missing_relationships'].append(record.id)
            
        except Exception as e:
            self.logger.error(f"خطأ في التحقق من سلامة البيانات: {str(e)}")
        
        return results
    
    def send_daily_report(self, archive_results: Dict):
        """إرسال تقرير يومي للأرشفة"""
        if not get_archive_setting('archive_admin_notification', True, 'boolean'):
            return
        
        try:
            # إنشاء محتوى التقرير
            report = f"""
تقرير الأرشفة اليومي - {datetime.now().strftime('%Y-%m-%d')}

نتائج الأرشفة التلقائية:
"""
            
            total_archived = 0
            for table, result in archive_results.items():
                if isinstance(result, dict) and result.get('success'):
                    count = result['successful_count']
                    total_archived += count
                    report += f"- {table}: {count} سجل\n"
            
            report += f"\nإجمالي السجلات المؤرشفة: {total_archived}\n"
            
            # حفظ التقرير في ملف أو إرساله عبر البريد الإلكتروني
            self.logger.info(f"تقرير يومي: {total_archived} سجل تم أرشفته")
            
        except Exception as e:
            self.logger.error(f"خطأ في إرسال التقرير اليومي: {str(e)}")

# دوال مساعدة إضافية
def get_archive_database_size() -> float:
    """حساب حجم قاعدة بيانات الأرشيف بالميجابايت"""
    try:
        result = db.session.execute("""
            SELECT 
                SUM(data_length + index_length) / 1024 / 1024 as size_mb
            FROM information_schema.tables 
            WHERE table_schema = 'kitchen_factory_archive'
        """).scalar()
        
        return float(result or 0)
    except:
        return 0.0

def check_stuck_operations() -> List[int]:
    """فحص العمليات المعلقة"""
    try:
        # العمليات التي تعمل لأكثر من ساعة
        one_hour_ago = datetime.utcnow() - timedelta(hours=1)
        
        stuck_ops = ArchiveOperationsLog.query.filter(
            ArchiveOperationsLog.status == 'running',
            ArchiveOperationsLog.operation_start < one_hour_ago
        ).all()
        
        return [op.id for op in stuck_ops]
    except:
        return []

# إنشاء مثيل النظام
archive_scheduler = None

def initialize_archive_scheduler(app):
    """تهيئة نظام الجدولة"""
    global archive_scheduler
    
    if get_archive_setting('archive_scheduler_enabled', True, 'boolean'):
        archive_scheduler = ArchiveScheduler(app)
        archive_scheduler.start()
    
def shutdown_archive_scheduler():
    """إيقاف نظام الجدولة"""
    global archive_scheduler
    
    if archive_scheduler:
        archive_scheduler.stop()
        archive_scheduler = None
```

### 📊 نظام المراقبة والتنبيهات

#### إنشاء نظام مراقبة الأرشيف
```python
# archive_monitoring.py - نظام مراقبة الأرشيف

import psutil
import os
from datetime import datetime, timedelta
from typing import Dict, List, Any
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart

class ArchiveMonitor:
    """نظام مراقبة الأرشيف والتنبيهات"""
    
    def __init__(self, app):
        self.app = app
        self.logger = logging.getLogger('archive_monitor')
        self.alerts = []
    
    def check_system_health(self) -> Dict[str, Any]:
        """فحص شامل لصحة النظام"""
        
        health_report = {
            'timestamp': datetime.utcnow(),
            'status': 'healthy',
            'checks': {},
            'alerts': [],
            'recommendations': []
        }
        
        # فحص استخدام القرص الصلب
        disk_check = self.check_disk_usage()
        health_report['checks']['disk'] = disk_check
        
        # فحص استخدام الذاكرة
        memory_check = self.check_memory_usage()
        health_report['checks']['memory'] = memory_check
        
        # فحص أداء قاعدة البيانات
        db_check = self.check_database_performance()
        health_report['checks']['database'] = db_check
        
        # فحص عمليات الأرشفة
        operations_check = self.check_archive_operations()
        health_report['checks']['operations'] = operations_check
        
        # تحديد الحالة العامة
        if any(check.get('status') == 'critical' for check in health_report['checks'].values()):
            health_report['status'] = 'critical'
        elif any(check.get('status') == 'warning' for check in health_report['checks'].values()):
            health_report['status'] = 'warning'
        
        # جمع التنبيهات والتوصيات
        for check_name, check_result in health_report['checks'].items():
            if check_result.get('alert'):
                health_report['alerts'].append({
                    'type': check_name,
                    'message': check_result['alert'],
                    'severity': check_result['status']
                })
            
            if check_result.get('recommendation'):
                health_report['recommendations'].append({
                    'type': check_name,
                    'message': check_result['recommendation']
                })
        
        return health_report
    
    def check_disk_usage(self) -> Dict[str, Any]:
        """فحص استخدام مساحة القرص"""
        try:
            # فحص مساحة قاعدة البيانات
            db_path = self.app.config.get('DATABASE_PATH', 'instance/kitchen_factory.db')
            disk_usage = psutil.disk_usage(os.path.dirname(db_path))
            
            used_percent = (disk_usage.used / disk_usage.total) * 100
            free_gb = disk_usage.free / (1024**3)
            
            result = {
                'status': 'healthy',
                'used_percent': round(used_percent, 1),
                'free_gb': round(free_gb, 1),
                'total_gb': round(disk_usage.total / (1024**3), 1)
            }
            
            # تحديد حالة التحذير
            if used_percent > 90:
                result['status'] = 'critical'
                result['alert'] = f'مساحة القرص ممتلئة تقريباً ({used_percent:.1f}%)'
                result['recommendation'] = 'قم بأرشفة أو حذف البيانات القديمة فوراً'
            elif used_percent > 80:
                result['status'] = 'warning' 
                result['alert'] = f'مساحة القرص منخفضة ({used_percent:.1f}%)'
                result['recommendation'] = 'فكر في أرشفة البيانات القديمة'
            
            return result
            
        except Exception as e:
            return {
                'status': 'error',
                'error': str(e),
                'alert': 'فشل فحص مساحة القرص'
            }
    
    def check_memory_usage(self) -> Dict[str, Any]:
        """فحص استخدام الذاكرة"""
        try:
            memory = psutil.virtual_memory()
            
            result = {
                'status': 'healthy',
                'used_percent': round(memory.percent, 1),
                'available_gb': round(memory.available / (1024**3), 1),
                'total_gb': round(memory.total / (1024**3), 1)
            }
            
            if memory.percent > 90:
                result['status'] = 'critical'
                result['alert'] = f'استخدام الذاكرة عالي جداً ({memory.percent:.1f}%)'
                result['recommendation'] = 'أعد تشغيل التطبيق أو قلل حجم العمليات'
            elif memory.percent > 75:
                result['status'] = 'warning'
                result['alert'] = f'استخدام الذاكرة عالي ({memory.percent:.1f}%)'
                result['recommendation'] = 'راقب الأداء وفكر في تحسين الاستعلامات'
            
            return result
            
        except Exception as e:
            return {
                'status': 'error',
                'error': str(e),
                'alert': 'فشل فحص استخدام الذاكرة'
            }
    
    def check_database_performance(self) -> Dict[str, Any]:
        """فحص أداء قاعدة البيانات"""
        try:
            # قياس وقت استعلام بسيط
            start_time = time.time()
            db.session.execute("SELECT 1").scalar()
            query_time = (time.time() - start_time) * 1000  # milliseconds
            
            # فحص حجم قاعدة البيانات
            db_size_mb = get_archive_database_size()
            
            # فحص عدد الاتصالات النشطة
            active_connections = db.session.execute(
                "SELECT COUNT(*) FROM information_schema.processlist"
            ).scalar()
            
            result = {
                'status': 'healthy',
                'query_time_ms': round(query_time, 2),
                'db_size_mb': round(db_size_mb, 1),
                'active_connections': active_connections
            }
            
            # تحديد حالات التحذير
            if query_time > 1000:  # أكثر من ثانية
                result['status'] = 'critical'
                result['alert'] = f'الاستعلامات بطيئة جداً ({query_time:.0f}ms)'
                result['recommendation'] = 'فحص الفهارس وتحسين الاستعلامات'
            elif query_time > 500:
                result['status'] = 'warning'
                result['alert'] = f'الاستعلامات بطيئة ({query_time:.0f}ms)'
                result['recommendation'] = 'مراجعة أداء قاعدة البيانات'
            
            if db_size_mb > 5000:  # أكثر من 5GB
                result['status'] = 'warning'
                result['alert'] = f'حجم قاعدة البيانات كبير ({db_size_mb:.0f}MB)'
                result['recommendation'] = 'قم بأرشفة البيانات القديمة'
            
            return result
            
        except Exception as e:
            return {
                'status': 'error',
                'error': str(e),
                'alert': 'فشل فحص أداء قاعدة البيانات'
            }
    
    def check_archive_operations(self) -> Dict[str, Any]:
        """فحص عمليات الأرشفة"""
        try:
            # فحص العمليات في آخر 24 ساعة
            yesterday = datetime.utcnow() - timedelta(days=1)
            
            recent_ops = ArchiveOperationsLog.query.filter(
                ArchiveOperationsLog.operation_start >= yesterday
            ).all()
            
            # إحصائيات العمليات
            total_ops = len(recent_ops)
            failed_ops = len([op for op in recent_ops if op.status == 'failed'])
            success_rate = ((total_ops - failed_ops) / total_ops * 100) if total_ops > 0 else 100
            
            # العمليات المعلقة
            stuck_ops = [op for op in recent_ops if op.status == 'running' and 
                        (datetime.utcnow() - op.operation_start).total_seconds() > 3600]
            
            result = {
                'status': 'healthy',
                'total_operations_24h': total_ops,
                'failed_operations_24h': failed_ops,
                'success_rate_percent': round(success_rate, 1),
                'stuck_operations': len(stuck_ops)
            }
            
            # تحديد حالات التحذير
            if success_rate < 80:
                result['status'] = 'critical'
                result['alert'] = f'معدل نجاح العمليات منخفض ({success_rate:.1f}%)'
                result['recommendation'] = 'فحص أخطاء الأرشفة وإصلاح المشاكل'
            elif success_rate < 95:
                result['status'] = 'warning'
                result['alert'] = f'بعض عمليات الأرشفة فشلت ({failed_ops} من {total_ops})'
                result['recommendation'] = 'مراجعة سجلات الأخطاء'
            
            if stuck_ops:
                result['status'] = 'warning'
                result['alert'] = f'توجد {len(stuck_ops)} عمليات معلقة'
                result['recommendation'] = 'إلغاء العمليات المعلقة وإعادة تشغيلها'
            
            return result
            
        except Exception as e:
            return {
                'status': 'error',
                'error': str(e),
                'alert': 'فشل فحص عمليات الأرشفة'
            }
    
    def send_alert_notification(self, alert: Dict[str, Any]):
        """إرسال تنبيه للمديرين"""
        if not get_archive_setting('archive_admin_notification', True, 'boolean'):
            return
        
        try:
            # تحضير رسالة التنبيه
            subject = f"تنبيه نظام الأرشفة - {alert['severity'].upper()}"
            
            message = f"""
تنبيه من نظام أرشفة مصنع المطابخ

النوع: {alert['type']}
الخطورة: {alert['severity']}
الرسالة: {alert['message']}

الوقت: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}

يرجى اتخاذ الإجراء المناسب.
"""
            
            # حفظ التنبيه في قاعدة البيانات
            self.save_alert_to_database(alert)
            
            # إرسال عبر البريد الإلكتروني (إذا تم تكوينه)
            self.send_email_notification(subject, message)
            
        except Exception as e:
            self.logger.error(f"فشل إرسال التنبيه: {str(e)}")
    
    def save_alert_to_database(self, alert: Dict[str, Any]):
        """حفظ التنبيه في قاعدة البيانات"""
        try:
            # يمكن إضافة جدول للتنبيهات لاحقاً
            self.logger.warning(f"تنبيه {alert['severity']}: {alert['message']}")
        except Exception as e:
            self.logger.error(f"فشل حفظ التنبيه: {str(e)}")
    
    def generate_monitoring_report(self) -> str:
        """إنشاء تقرير مراقبة شامل"""
        health_report = self.check_system_health()
        
        report = f"""
تقرير مراقبة نظام الأرشفة
التاريخ: {health_report['timestamp'].strftime('%Y-%m-%d %H:%M:%S')}
الحالة العامة: {health_report['status'].upper()}

=== فحص النظام ===
"""
        
        for check_name, check_result in health_report['checks'].items():
            report += f"\n{check_name.upper()}: {check_result['status'].upper()}\n"
            
            if check_name == 'disk':
                report += f"  - استخدام القرص: {check_result['used_percent']}%\n"
                report += f"  - المساحة المتاحة: {check_result['free_gb']:.1f} GB\n"
            elif check_name == 'memory':
                report += f"  - استخدام الذاكرة: {check_result['used_percent']}%\n"
                report += f"  - الذاكرة المتاحة: {check_result['available_gb']:.1f} GB\n"
            elif check_name == 'database':
                report += f"  - وقت الاستعلام: {check_result['query_time_ms']} ms\n"
                report += f"  - حجم قاعدة البيانات: {check_result['db_size_mb']:.1f} MB\n"
            elif check_name == 'operations':
                report += f"  - العمليات (24 ساعة): {check_result['total_operations_24h']}\n"
                report += f"  - معدل النجاح: {check_result['success_rate_percent']}%\n"
            
            if check_result.get('alert'):
                report += f"  ⚠️  تحذير: {check_result['alert']}\n"
            
            if check_result.get('recommendation'):
                report += f"  💡 توصية: {check_result['recommendation']}\n"
        
        # إضافة التوصيات العامة
        if health_report['recommendations']:
            report += "\n=== التوصيات ===\n"
            for i, rec in enumerate(health_report['recommendations'], 1):
                report += f"{i}. {rec['message']}\n"
        
        return report

# تهيئة نظام المراقبة
archive_monitor = None

def initialize_archive_monitor(app):
    """تهيئة نظام مراقبة الأرشيف"""
    global archive_monitor
    archive_monitor = ArchiveMonitor(app)

def get_system_health():
    """الحصول على حالة النظام الحالية"""
    if archive_monitor:
        return archive_monitor.check_system_health()
    return {'status': 'unknown', 'message': 'نظام المراقبة غير مفعل'}
```

---

## 📚 المرحلة السابعة: التدريب والتوثيق

### 📖 دليل المستخدم الشامل

#### دليل استخدام نظام الأرشفة
```markdown
# دليل المستخدم - نظام الأرشفة الشامل

## مقدمة
نظام الأرشفة الشامل هو نظام متطور لإدارة البيانات القديمة والمكتملة في نظام إدارة مصنع المطابخ. يهدف النظام إلى تحسين الأداء وتنظيم البيانات مع الحفاظ على إمكانية الوصول للمعلومات التاريخية عند الحاجة.

## الأهداف الرئيسية
- تحسين أداء النظام بنقل البيانات القديمة إلى أرشيف منفصل
- الحفاظ على البيانات التاريخية مع إمكانية البحث والاستعادة
- توفير مساحة تخزين وتقليل حجم قاعدة البيانات الرئيسية
- ضمان الأمان والخصوصية للبيانات المؤرشفة

## الصلاحيات والأدوار

### مستويات الصلاحيات
1. **مشاهد الأرشيف** (Archive Viewer)
   - الأدوار المسموحة: مدير، مسؤول العمليات
   - الصلاحيات:
     - عرض لوحة معلومات الأرشيف
     - البحث في البيانات المؤرشفة
     - عرض تفاصيل السجلات المؤرشفة
     - عرض الإحصائيات والتقارير

2. **مدير الأرشيف** (Archive Manager)
   - الأدوار المسموحة: مدير
   - الصلاحيات الإضافية:
     - أرشفة السجلات يدوياً
     - استعادة السجلات من الأرشيف
     - الأرشفة الجماعية
     - إدارة جداول الأرشفة التلقائية

3. **مشرف الأرشيف** (Archive Admin)  
   - الأدوار المسموحة: مدير
   - الصلاحيات الكاملة:
     - جميع صلاحيات المستويات السابقة
     - تشغيل الأرشفة التلقائية يدوياً
     - تعديل إعدادات النظام
     - إدارة النسخ الاحتياطية

## الوصول لنظام الأرشيف

### 1. لوحة الأرشيف الرئيسية
- **الرابط:** `/archive`
- **الوصف:** عرض شامل لحالة النظام والإحصائيات
- **المحتوى:**
  - إحصائيات سريعة (العدد الإجمالي، الحجم، الجداول النشطة)
  - جدول الإحصائيات التفصيلية لكل نوع بيانات
  - سجل العمليات الأخيرة
  - أزرار الإجراءات السريعة

### 2. البحث المتقدم
- **الرابط:** `/archive/search`
- **الوصف:** بحث مفصل في جميع البيانات المؤرشفة
- **معايير البحث:**
  - نوع البيانات (طلبيات، فواتير، مستحقات، إلخ)
  - النطاق الزمني (من تاريخ - إلى تاريخ)
  - سبب الأرشفة
  - المستخدم الذي قام بالأرشفة
  - حد عدد النتائج

### 3. عرض البيانات المؤرشفة
- **طلبيات مؤرشفة:** `/archive/orders`
- **فواتير مؤرشفة:** `/archive/invoices`
- **مستحقات مؤرشفة:** `/archive/technician-dues`

## العمليات الأساسية

### 1. أرشفة البيانات

#### الأرشفة التلقائية
النظام يقوم تلقائياً بأرشفة البيانات المؤهلة حسب الإعدادات:
- **الطلبيات:** بعد 90 يوم من التسليم (قابل للتخصيص)
- **الفواتير:** بعد 120 يوم من آخر دفعة (قابل للتخصيص)
- **مستحقات الفنيين:** بعد 180 يوم من الدفع (قابل للتخصيص)

#### الأرشفة اليدوية
للمديرين فقط:
1. انتقل إلى السجل المراد أرشفته
2. اضغط على زر "أرشفة" 
3. أدخل سبب الأرشفة
4. أكد العملية

#### الأرشفة الجماعية
1. انتقل إلى `/archive/bulk-archive`
2. اختر نوع البيانات
3. حدد السجلات المراد أرشفتها
4. أدخل سبب الأرشفة الجماعية
5. أكد العملية

### 2. البحث في الأرشيف

#### البحث البسيط
1. انتقل إلى لوحة الأرشيف
2. اضغط على نوع البيانات المطلوب
3. استخدم فلاتر البحث المتاحة

#### البحث المتقدم
1. انتقل إلى `/archive/search`
2. املأ معايير البحث المطلوبة
3. اضغط "بحث"
4. راجع النتائج ويمكنك:
   - عرض تفاصيل أي سجل
   - تصدير النتائج
   - استعادة سجلات (للمديرين)

### 3. استعادة البيانات

#### استعادة سجل واحد (للمديرين فقط)
1. ابحث عن السجل في الأرشيف
2. اضغط على زر "استعادة" 
3. أدخل سبب الاستعادة
4. أكد العملية
5. السجل سيعود للنظام الرئيسي

#### الاستعادة الجماعية
1. في صفحة البحث، حدد السجلات المطلوبة
2. اضغط "استعادة متعددة"
3. أدخل سبب الاستعادة
4. أكد العملية

### 4. عرض الإحصائيات والتقارير

#### إحصائيات شاملة
- انتقل إلى `/archive/statistics`
- عرض تفصيلي لجميع إحصائيات النظام
- مقارنات بالأداء السابق
- رسوم بيانية ومخططات

#### التقارير الدورية
النظام ينشئ تقارير تلقائية:
- تقرير يومي: يُرسل للمديرين صباحاً
- تقرير أسبوعي: تحليل شامل للأداء
- تقرير شهري: إحصائيات ومقارنات

## الإعدادات والتخصيص

### إعدادات الأرشفة (للمديرين)
يمكن تخصيص النظام من خلال إعدادات النظام:

#### الفترات الزمنية
- `order_auto_archive_days`: أيام أرشفة الطلبيات (افتراضي: 90)
- `invoice_auto_archive_days`: أيام أرشفة الفواتير (افتراضي: 120)
- `technician_payment_archive_days`: أيام أرشفة مستحقات الفنيين (افتراضي: 180)

#### الأداء والكفاءة
- `archive_batch_size`: حجم دفعة الأرشفة (افتراضي: 50)
- `archive_max_daily_records`: الحد الأقصى اليومي (افتراضي: 500)

#### التنبيهات والإشعارات
- `archive_admin_notification`: إرسال إشعارات للمديرين (افتراضي: تفعيل)
- `archive_daily_maintenance_time`: وقت الصيانة اليومية (افتراضي: 02:00)

## نصائح الاستخدام

### للمديرين
1. **راجع التقارير اليومية** للتأكد من سير العمل بسلاسة
2. **استخدم البحث المتقدم** للعثور على البيانات التاريخية بسرعة
3. **فعّل الأرشفة التلقائية** لتوفير الوقت والجهد
4. **راقب مساحة التخزين** وقم بالأرشفة عند الحاجة

### للمستخدمين
1. **استخدم الفلاتر** في البحث لتحسين دقة النتائج
2. **احفظ النتائج المهمة** قبل الخروج من الصفحة
3. **تحقق من التواريخ** عند البحث في البيانات القديمة

## استكشاف الأخطاء

### المشاكل الشائعة وحلولها

#### "لا توجد نتائج للبحث"
- تحقق من معايير البحث
- جرب توسيع النطاق الزمني
- استخدم كلمات مفتاحية أقل تحديداً

#### "فشل في أرشفة السجل"
- تحقق من صلاحيات المستخدم
- تأكد من أن السجل مؤهل للأرشفة
- راجع سجل الأخطاء

#### "بطء في تحميل البيانات"
- قلل عدد النتائج في البحث
- استخدم فلاتر أكثر تحديداً
- تحقق من حالة الخادم

### طلب المساعدة
في حالة مواجهة مشاكل:
1. سجل تفاصيل المشكلة (الرسائل، الخطوات)
2. أرفق لقطة شاشة إن أمكن
3. تواصل مع الدعم التقني
4. اذكر دورك في النظام ونوع العملية

## الأمان وأفضل الممارسات

### حماية البيانات
- جميع البيانات الحساسة مشفرة في الأرشيف
- الوصول محدود بالصلاحيات
- جميع العمليات مسجلة في سجل التدقيق

### أفضل الممارسات
1. **لا تؤرشف** البيانات التي قد تحتاجها قريباً
2. **أدخل أسباب واضحة** للأرشفة والاستعادة
3. **راجع البيانات** قبل الأرشفة النهائية
4. **احتفظ بنسخ احتياطية** من البيانات المهمة

## التحديثات والصيانة

النظام يقوم بصيانة تلقائية:
- **يومياً (2:00 صباحاً):** أرشفة تلقائية وتنظيف السجلات
- **أسبوعياً (الأحد 1:00 صباحاً):** صيانة شاملة ونسخ احتياطي
- **شهرياً:** مراجعة شاملة وتحديث الإحصائيات
```

---

## 🎯 المرحلة الثامنة: خطة التنفيذ التفصيلية

### 📅 الجدول الزمني النهائي

#### أسبوع 1-2: إعداد البنية التحتية
**الأيام 1-3: إعداد قاعدة البيانات**
- [ ] إنشاء قاعدة بيانات الأرشيف أو المخطط المنفصل
- [ ] إنشاء جداول البيانات الوصفية (metadata, relationships, statistics, etc.)
- [ ] إنشاء جداول البيانات المؤرشفة (archive_orders, archive_invoices, etc.)
- [ ] إنشاء الفهارس والقيود المطلوبة
- [ ] اختبار الاتصال والعمليات الأساسية

**الأيام 4-7: تطوير النماذج الأساسية**
- [ ] إضافة نماذج Flask للأرشيف في `app.py`
- [ ] إعداد ربط قاعدة البيانات المتعددة (multi-database binding)
- [ ] تطوير دوال الأرشفة الأساسية
- [ ] إضافة دوال المساعدة والتحقق
- [ ] إجراء اختبارات وحدة أولية

**الأيام 8-14: تطوير منطق الأعمال**
- [ ] تطوير دوال الأرشفة للسجلات المفردة
- [ ] تطوير نظام الأرشفة الجماعية
- [ ] إضافة نظام العلاقات والتبعيات
- [ ] تطوير دوال الاستعادة
- [ ] إضافة نظام التحقق من سلامة البيانات

#### أسبوع 3-4: تطوير الواجهات والمسارات
**الأيام 15-21: المسارات والتوجيه**
- [ ] إضافة مسارات الأرشيف إلى Flask
- [ ] تطوير نظام الصلاحيات والتحكم بالوصول
- [ ] إضافة مسارات البحث والفلترة
- [ ] تطوير مسارات الإدارة والإحصائيات
- [ ] اختبار جميع المسارات

**الأيام 22-28: الواجهات وتجربة المستخدم**
- [ ] تطوير قوالب HTML للوحة الأرشيف
- [ ] إنشاء واجهة البحث المتقدم
- [ ] تطوير صفحات عرض البيانات المؤرشفة
- [ ] إضافة واجهات الإحصائيات والتقارير
- [ ] تحسين تجربة المستخدم وإضافة JavaScript

#### أسبوع 5-6: النظم المساعدة والأتمتة
**الأيام 29-35: نظام الجدولة والمراقبة**
- [ ] تطوير نظام الجدولة التلقائية
- [ ] إضافة نظام مراقبة الأداء والصحة
- [ ] تطوير نظام التنبيهات والإشعارات
- [ ] إضافة المهام الدورية (يومية، أسبوعية، شهرية)
- [ ] اختبار النظم المساعدة

**الأيام 36-42: التحسين والأمان**
- [ ] تطبيق تشفير البيانات الحساسة
- [ ] تحسين الاستعلامات والفهارس
- [ ] إضافة نظام النسخ الاحتياطي
- [ ] تطوير آليات الاسترداد في حالة الطوارئ
- [ ] مراجعة شاملة للأمان

#### أسبوع 7-8: الاختبار والتوثيق
**الأيام 43-49: الاختبار الشامل**
- [ ] اختبار الوحدة لجميع الدوال
- [ ] اختبار التكامل للنظام الكامل
- [ ] اختبار الأداء مع بيانات كثيرة
- [ ] اختبار السيناريوهات الحدية
- [ ] اختبار الأمان والصلاحيات

**الأيام 50-56: التوثيق والتدريب**
- [ ] إنجاز دليل المستخدم الشامل
- [ ] كتابة التوثيق التقني للمطورين
- [ ] إعداد مواد التدريب
- [ ] تحديث جميع ملفات التوثيق الموجودة
- [ ] تجهيز عروض التدريب

### 📊 معايير الإنجاز لكل مرحلة

#### المرحلة الأولى: البنية التحتية ✅
**معايير الإنجاز:**
- [ ] قاعدة بيانات الأرشيف تعمل بدون أخطاء
- [ ] جميع الجداول المطلوبة منشأة بالفهارس الصحيحة
- [ ] اختبار الاتصال والعمليات الأساسية ناجح
- [ ] النماذج الأساسية تعمل مع العلاقات الصحيحة
- [ ] دوال الأرشفة الأساسية تعمل على عينة من البيانات

#### المرحلة الثانية: التطبيق ✅
**معايير الإنجاز:**
- [ ] أرشفة وإستعادة السجلات المفردة تعمل بنجاح 100%
- [ ] الأرشفة الجماعية تعمل بكفاءة مع دفعات مختلفة الأحجام
- [ ] نظام العلاقات يحافظ على تكامل البيانات
- [ ] البحث في الأرشيف يعيد نتائج دقيقة وسريعة
- [ ] جميع المسارات تعمل مع الصلاحيات الصحيحة

#### المرحلة الثالثة: الواجهات ✅
**معايير الإنجاز:**
- [ ] جميع الواجهات تعمل بسلاسة على متصفحات مختلفة
- [ ] البحث والفلترة سريعة ودقيقة
- [ ] الإحصائيات والتقارير تعرض بيانات صحيحة
- [ ] واجهة المستخدم بديهية وسهلة الاستخدام
- [ ] الاستجابة للأجهزة المحمولة جيدة

#### المرحلة الرابعة: الأتمتة ✅
**معايير الإنجاز:**
- [ ] الجدولة التلقائية تعمل حسب الأوقات المحددة
- [ ] نظام المراقبة يكتشف المشاكل ويرسل تنبيهات
- [ ] المهام الدورية تعمل دون تدخل يدوي
- [ ] النسخ الاحتياطي ينشأ بانتظام
- [ ] نظام الاسترداد يعمل في حالات الطوارئ

### 🔄 خطة الاختبار والتحقق

#### اختبار الأداء
```sql
-- اختبار سرعة الأرشفة
PROCEDURE test_archive_performance()
BEGIN
    DECLARE start_time TIMESTAMP DEFAULT NOW();
    
    -- أرشفة 100 طلبية
    CALL archive_batch_orders(100);
    
    SELECT TIMESTAMPDIFF(SECOND, start_time, NOW()) as duration_seconds;
END;

-- اختبار سرعة البحث
SELECT 
    COUNT(*) as result_count,
    BENCHMARK(1000, (
        SELECT COUNT(*) FROM archive_metadata 
        WHERE source_table = 'orders' 
        AND archived_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
    )) as search_performance;
```

#### اختبار سلامة البيانات
```python
def test_data_integrity():
    """اختبار سلامة البيانات المؤرشفة"""
    
    # اختبار checksum
    metadata_records = ArchiveMetadata.query.limit(50).all()
    for record in metadata_records:
        if record.original_record_json and record.checksum:
            original_data = json.loads(record.original_record_json)
            calculated_checksum = calculate_data_checksum(original_data)
            assert calculated_checksum == record.checksum, f"Checksum mismatch for record {record.id}"
    
    # اختبار العلاقات
    orders_count = ArchiveMetadata.query.filter_by(source_table='orders').count()
    relationships_count = ArchiveRelationship.query.filter_by(parent_table='orders').count()
    
    # يجب أن يكون لكل طلبية مؤرشفة علاقات مرتبطة
    assert relationships_count > 0, "No relationships found for archived orders"
    
    return True
```

---

## 🎉 النتائج المتوقعة والفوائد

### 📈 تحسينات الأداء المتوقعة

#### الأداء التقني
- **تحسن سرعة الاستعلامات: 70-80%**
  - الاستعلامات على الطلبيات من 2-3 ثانية إلى 0.3-0.5 ثانية
  - استعلامات التقارير من 10-15 ثانية إلى 2-3 ثواني
  - استعلامات البحث من 5-8 ثواني إلى 1-2 ثانية

#### تحسين استخدام الموارد
- **تقليل حجم قاعدة البيانات الرئيسية: 50-60%**
  - من 2-3 GB إلى 800MB-1.2GB (تقدير)
  - تحسن سرعة النسخ الاحتياطي بنسبة 60%
  - تقليل استخدام الذاكرة بنسبة 40%

### 💼 الفوائد التشغيلية

#### للإدارة
- **تحسن في إدارة البيانات:**
  - تنظيم أفضل للبيانات النشطة مقابل التاريخية
  - سهولة الوصول للمعلومات التاريخية عند الحاجة
  - تقارير أسرع وأكثر دقة

- **توفير في التكاليف:**
  - تقليل تكاليف التخزين بنسبة 40-50%
  - تحسن كفاءة النظام يقلل حاجة ترقية الأجهزة
  - توفير وقت الصيانة والنسخ الاحتياطي

#### للمستخدمين
- **تجربة أفضل:**
  - سرعة أكبر في تحميل الصفحات
  - استجابة أسرع للبحث والفلترة
  - واجهة أكثر تنظيماً وأقل ازدحاماً

### 🔮 الفوائد طويلة المدى

#### القابلية للتوسع
- **نمو مستدام:**
  - النظام يدعم نمو البيانات لسنوات قادمة
  - إمكانية إضافة أنواع بيانات جديدة للأرشفة
  - مرونة في تخصيص قواعد الأرشفة

#### الصيانة والتطوير
- **كود أكثر تنظيماً:**
  - فصل واضح بين البيانات النشطة والتاريخية
  - سهولة إضافة ميزات جديدة
  - تحسن في قابلية الصيانة

---

## 📋 قائمة المراجعة النهائية

### ✅ قبل البدء بالتنفيذ

#### التحضير التقني
- [ ] مراجعة جميع أجزاء الخطة والموافقة عليها
- [ ] التأكد من توفر بيئة تطوير واختبار منفصلة
- [ ] إنشاء نسخ احتياطية شاملة من النظام الحالي
- [ ] التأكد من توفر الصلاحيات اللازمة لقاعدة البيانات
- [ ] تجهيز أدوات المراقبة والاختبار

#### التحضير البشري
- [ ] تجهيز فريق التطوير والاختبار
- [ ] تحديد المسؤوليات والأدوار
- [ ] إعداد خطة التواصل والتحديثات
- [ ] تحديد نقاط المراجعة والموافقة

### ✅ أثناء التنفيذ

#### مراقبة التقدم
- [ ] متابعة الجدول الزمني يومياً
- [ ] مراجعة معايير الجودة في كل مرحلة
- [ ] اختبار مستمر للميزات المطورة
- [ ] توثيق أي تغييرات أو تعديلات على الخطة

#### إدارة المخاطر
- [ ] مراقبة المشاكل المحتملة واتخاذ إجراءات وقائية
- [ ] الحفاظ على النسخ الاحتياطية محدثة
- [ ] الاستعداد للتراجع في حالة المشاكل الكبيرة

### ✅ بعد اكتمال التنفيذ

#### التحقق والاختبار
- [ ] اختبار شامل لجميع الوظائف
- [ ] قياس تحسن الأداء ومقارنته بالأهداف
- [ ] التأكد من عمل جميع النظم المساعدة
- [ ] مراجعة الأمان والصلاحيات

#### التدريب والنشر
- [ ] تدريب جميع المستخدمين
- [ ] نشر التوثيق والأدلة
- [ ] تفعيل النظام في الإنتاج تدريجياً
- [ ] متابعة الأداء لمدة أسبوع على الأقل

#### الصيانة والمتابعة
- [ ] إعداد جداول المراقبة والصيانة
- [ ] تحديد إجراءات الدعم الفني
- [ ] وضع خطة التحسينات المستقبلية

---

**🎯 هذه كانت خطة نظام الأرشفة الشامل - الجزء الثالث والأخير، والذي ركز على الإدارة والصيانة والتنفيذ.**

**📌 ملاحظة مهمة:** هذا دليل شامل للتنفيذ. لا تبدأ أي عمل حتى مراجعة واعتماد الخطة كاملة والحصول على الموافقة النهائية للبدء.

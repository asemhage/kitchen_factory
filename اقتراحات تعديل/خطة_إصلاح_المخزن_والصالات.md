# خطة إصلاح: فصل المخزن عن الصالات

**التاريخ:** 2025-10-09  
**الأولوية:** عالية 🔴

## المشكلة الحالية

### 1. خطأ `showroom_id = None` عند إضافة مورد
```
NOT NULL constraint failed: suppliers.showroom_id
```
**السبب:** دالة `get_user_showroom_id()` ترجع `None` للمدير عندما لا يكون فلتر الصالة مفعّل.

**الحل:** ✅ تم الإصلاح - إضافة fallback لأول صالة نشطة.

---

### 2. المخزن مرتبط بالصالة (خطأ منطقي)
**المشكلة:**
- جدول `Material` يحتوي على `showroom_id`
- هذا يعني كل صالة لها مخزن منفصل
- **المنطق الصحيح:** المخزن واحد مشترك بين جميع الصالات

**التأثير:**
- تكرار غير ضروري للمواد
- صعوبة في إدارة المخزن الموحد
- تعقيد في تتبع الكميات الإجمالية

---

## الحل المقترح

### الخيار 1: إزالة `showroom_id` من `Material` تماماً ✅ (موصى به)

**المنطق:**
- المخزن واحد للمصنع كله
- جميع الصالات تسحب من نفس المخزن
- الموردون يضيفون إلى المخزن الموحد
- فواتير الشراء مرتبطة بالصالة (من أضافها)، لكن المواد تذهب للمخزن الموحد

**التغييرات المطلوبة:**

1. **تعديل نموذج `Material`:**
   - حذف `showroom_id`
   - حذف `showroom` relationship
   - إضافة حقل `warehouse_location` (اختياري)

2. **تعديل نموذج `Showroom`:**
   - حذف `materials` relationship

3. **Migration Script:**
   - حذف عمود `showroom_id` من جدول `material`
   - نقل البيانات المكررة (دمج المواد المتشابهة)

4. **تحديث المسارات:**
   - `/materials`: إزالة فلتر الصالة
   - `/material/new`: إزالة `showroom_id`
   - `/material/<id>/edit`: إزالة `showroom_id`
   - `get_scoped_query()`: استثناء `Material`

5. **تحديث التقارير:**
   - تقرير المواد المنخفضة: عرض جميع المواد
   - تقرير استهلاك المواد: الفلترة حسب الطلبات (وليس المواد)

**المزايا:**
- ✅ منطق أبسط وأوضح
- ✅ لا تكرار للمواد
- ✅ إدارة موحدة للمخزن
- ✅ تتبع دقيق للكميات

**العيوب:**
- ⚠️ Migration معقدة قليلاً (دمج المواد)
- ⚠️ تغيير في منطق العرض

---

### الخيار 2: إبقاء `showroom_id` كحقل اختياري

**المنطق:**
- بعض المواد قد تكون خاصة بصالة معينة
- المواد بدون `showroom_id` تكون مشتركة

**العيوب:**
- ❌ تعقيد في المنطق
- ❌ احتمال وجود تكرار
- ❌ صعوبة في التتبع

---

## القرار الموصى به

**✅ الخيار 1: إزالة `showroom_id` من `Material` تماماً**

### الخطوات التنفيذية:

#### 1️⃣ النسخ الاحتياطي
```powershell
Copy-Item "kitchen_factory/instance/kitchen_factory.db" `
          "kitchen_factory/instance/kitchen_factory_backup_$(Get-Date -Format 'yyyyMMdd_HHmmss').db"
```

#### 2️⃣ تحليل البيانات الحالية
```python
# فحص المواد المكررة عبر الصالات
SELECT name, unit, COUNT(*) as count, GROUP_CONCAT(showroom_id) as showrooms
FROM material
GROUP BY name, unit
HAVING count > 1;
```

#### 3️⃣ Migration Script
- دمج المواد المكررة
- جمع الكميات
- حساب متوسط الأسعار
- حذف `showroom_id`

#### 4️⃣ تحديث الكود
- تعديل النماذج
- تحديث المسارات
- تحديث القوالب
- تحديث التقارير

#### 5️⃣ الاختبار
- اختبار إضافة مادة
- اختبار تعديل مادة
- اختبار الطلبات
- اختبار التقارير

---

## الأولوية

**🔴 عالية جداً** - يجب الإصلاح قبل المتابعة في تطوير نظام الفواتير

---

## الخطوة التالية

انتظار موافقة المستخدم على:
1. ✅ هل نقوم بفصل المخزن عن الصالات؟
2. ✅ متى نبدأ (الآن أم بعد إكمال نظام الفواتير)؟


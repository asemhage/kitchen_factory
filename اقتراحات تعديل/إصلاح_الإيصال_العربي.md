# 🔧 إصلاح عرض اللغة العربية في إيصالات PDF

**التاريخ**: 2025-10-08  
**المشكلة**: النص العربي يظهر كمربعات سوداء (████) في ملفات PDF

---

## 📊 المشكلة

### الأعراض:
```
Kitchen Factory
Receipt / ايصال قبض  → يظهر: Receipt / █████ ███

Order ID / رقم الطلب: 1  → يظهر: Order ID / ███ █████: 1
Customer / العميل: asm  → يظهر: Customer / ██████: asm
```

### السبب الجذري:
1. **الخط المستخدم**: `Helvetica` لا يدعم الأحرف العربية
2. **reportlab**: يحتاج إلى تسجيل خط TrueType يدعم العربية
3. **السطر 786**: `p.setFont("Helvetica", 12)` ← خط لاتيني فقط

---

## ✅ الحل المقترح

### الخيار 1: استخدام خط Amiri (موصى به) ⭐

**المميزات**:
- ✅ خط عربي احترافي مفتوح المصدر
- ✅ يدعم العربية والإنجليزية
- ✅ جميل ومقروء
- ✅ مجاني 100%

**الخطوات**:

#### 1. تحميل الخط
```bash
# تحميل خط Amiri من Google Fonts
# الرابط: https://fonts.google.com/specimen/Amiri
```

أو استخدام خط موجود في Windows:
- `C:\Windows\Fonts\arial.ttf` - Arial Unicode MS
- `C:\Windows\Fonts\tahoma.ttf` - Tahoma
- `C:\Windows\Fonts\calibri.ttf` - Calibri

#### 2. نسخ الخط إلى المشروع
```
kitchen_factory/
  fonts/
    Amiri-Regular.ttf
    Amiri-Bold.ttf
```

#### 3. تحديث الكود في `app.py`

**الإضافة في بداية الملف** (بعد السطر 15):
```python
import os

# تسجيل الخطوط العربية
FONTS_DIR = os.path.join(os.path.dirname(__file__), 'fonts')

def register_arabic_fonts():
    """تسجيل الخطوط العربية لاستخدامها في PDF"""
    try:
        # محاولة تسجيل خط Amiri
        amiri_regular = os.path.join(FONTS_DIR, 'Amiri-Regular.ttf')
        amiri_bold = os.path.join(FONTS_DIR, 'Amiri-Bold.ttf')
        
        if os.path.exists(amiri_regular):
            pdfmetrics.registerFont(TTFont('Amiri', amiri_regular))
            pdfmetrics.registerFont(TTFont('Amiri-Bold', amiri_bold))
            return 'Amiri'
        
        # البديل: استخدام خطوط Windows
        windows_fonts = {
            'Arial': 'C:\\Windows\\Fonts\\arial.ttf',
            'Tahoma': 'C:\\Windows\\Fonts\\tahoma.ttf',
            'Calibri': 'C:\\Windows\\Fonts\\calibri.ttf'
        }
        
        for font_name, font_path in windows_fonts.items():
            if os.path.exists(font_path):
                pdfmetrics.registerFont(TTFont(font_name, font_path))
                return font_name
        
        # إذا لم يُعثر على أي خط
        return None
        
    except Exception as e:
        print(f"خطأ في تسجيل الخطوط: {str(e)}")
        return None
```

#### 4. تحديث دالة `generate_receipt_pdf`

**قبل** (السطر 775-788):
```python
def generate_receipt_pdf(order, deposit_amount=None):
    """إنشاء إيصال قبض PDF للعربون"""
    buffer = io.BytesIO()
    
    # إنشاء مستند PDF
    p = canvas.Canvas(buffer, pagesize=A4)
    width, height = A4
    
    # إعداد النص العربي (استخدام خط افتراضي يدعم العربية)
    try:
        # محاولة استخدام خط عربي إذا كان متوفراً
        p.setFont("Helvetica", 12)  # ❌ لا يدعم العربية
    except:
        p.setFont("Helvetica", 12)
```

**بعد**:
```python
def generate_receipt_pdf(order, deposit_amount=None):
    """إنشاء إيصال قبض PDF للعربون"""
    buffer = io.BytesIO()
    
    # إنشاء مستند PDF
    p = canvas.Canvas(buffer, pagesize=A4)
    width, height = A4
    
    # تسجيل وتحديد الخط العربي
    arabic_font = register_arabic_fonts()
    
    if arabic_font:
        # استخدام الخط العربي
        default_font = arabic_font
        bold_font = f"{arabic_font}-Bold" if arabic_font == "Amiri" else arabic_font
    else:
        # البديل: استخدام Helvetica (لن يعرض العربية بشكل صحيح)
        default_font = "Helvetica"
        bold_font = "Helvetica-Bold"
    
    # تطبيق الخط
    p.setFont(default_font, 12)
```

#### 5. تحديث باقي أسطر الخطوط

**استبدال جميع**:
- `p.setFont("Helvetica-Bold", 16)` → `p.setFont(bold_font, 16)`
- `p.setFont("Helvetica", 12)` → `p.setFont(default_font, 12)`
- `p.setFont("Helvetica-Bold", 12)` → `p.setFont(bold_font, 12)`

---

### الخيار 2: استخدام arabic_reshaper + bidi (الأفضل للعربية) 🌟

**المميزات**:
- ✅ يدعم تشكيل الأحرف العربية بشكل صحيح
- ✅ يدعم الاتجاه من اليمين لليسار (RTL)
- ✅ حل مثبت وموثوق

**التثبيت**:
```bash
pip install arabic-reshaper python-bidi
```

**الكود**:
```python
from arabic_reshaper import reshape
from bidi.algorithm import get_display

def format_arabic_text(text):
    """تنسيق النص العربي للعرض الصحيح في PDF"""
    try:
        reshaped_text = reshape(text)
        bidi_text = get_display(reshaped_text)
        return bidi_text
    except:
        return text

# في generate_receipt_pdf:
subtitle_text = format_arabic_text("ايصال قبض")
p.drawString(x, y, f"Receipt / {subtitle_text}")
```

---

## 🎯 الحل الموصى به (مختلط)

**الجمع بين الخيارين للحصول على أفضل نتيجة**:

### 1. التثبيت:
```bash
pip install arabic-reshaper python-bidi
```

### 2. الكود الكامل:

```python
import os
from arabic_reshaper import reshape
from bidi.algorithm import get_display
from reportlab.lib.pagesizes import A4
from reportlab.pdfgen import canvas
from reportlab.lib.units import cm
from reportlab.pdfbase.ttfonts import TTFont
from reportlab.pdfbase import pdfmetrics

# مسار مجلد الخطوط
FONTS_DIR = os.path.join(os.path.dirname(__file__), 'fonts')

def register_arabic_fonts():
    """تسجيل الخطوط العربية لاستخدامها في PDF"""
    try:
        # محاولة تسجيل خط Amiri
        amiri_regular = os.path.join(FONTS_DIR, 'Amiri-Regular.ttf')
        
        if os.path.exists(amiri_regular):
            pdfmetrics.registerFont(TTFont('Amiri', amiri_regular))
            return 'Amiri'
        
        # البديل: استخدام Arial من Windows
        arial_path = 'C:\\Windows\\Fonts\\arial.ttf'
        if os.path.exists(arial_path):
            pdfmetrics.registerFont(TTFont('Arial-Unicode', arial_path))
            return 'Arial-Unicode'
        
        return None
        
    except Exception as e:
        print(f"خطأ في تسجيل الخطوط: {str(e)}")
        return None

def format_arabic_text(text):
    """تنسيق النص العربي للعرض الصحيح في PDF"""
    try:
        reshaped_text = reshape(text)
        bidi_text = get_display(reshaped_text)
        return bidi_text
    except Exception as e:
        print(f"خطأ في تنسيق النص العربي: {str(e)}")
        return text

def generate_receipt_pdf(order, deposit_amount=None):
    """إنشاء إيصال قبض PDF للعربون"""
    buffer = io.BytesIO()
    
    # إنشاء مستند PDF
    p = canvas.Canvas(buffer, pagesize=A4)
    width, height = A4
    
    # تسجيل الخط العربي
    arabic_font = register_arabic_fonts()
    font_name = arabic_font if arabic_font else "Helvetica"
    
    # رأس الإيصال
    p.setFont(font_name, 16)
    
    # العنوان (بالإنجليزية)
    title_text = "Kitchen Factory"
    title_width = p.stringWidth(title_text, font_name, 16)
    p.drawString((width - title_width) / 2, height - 2*cm, title_text)
    
    # العنوان الفرعي (عربي + إنجليزي)
    subtitle_ar = format_arabic_text("ايصال قبض")
    subtitle_text = f"Receipt / {subtitle_ar}"
    subtitle_width = p.stringWidth(subtitle_text, font_name, 14)
    p.setFont(font_name, 14)
    p.drawString((width - subtitle_width) / 2, height - 2.8*cm, subtitle_text)
    
    # معلومات الإيصال
    y_position = height - 4.5*cm
    p.setFont(font_name, 12)
    
    # رقم الطلب
    order_label = format_arabic_text("رقم الطلب")
    p.drawString(2*cm, y_position, f"Order ID / {order_label}: {order.id}")
    y_position -= 0.8*cm
    
    # اسم العميل
    customer_label = format_arabic_text("العميل")
    p.drawString(2*cm, y_position, f"Customer / {customer_label}: {order.customer.name}")
    y_position -= 0.8*cm
    
    # تاريخ الإيصال
    date_label = format_arabic_text("التاريخ")
    p.drawString(2*cm, y_position, f"Date / {date_label}: {datetime.now().strftime('%Y-%m-%d %H:%M')}")
    y_position -= 0.8*cm
    
    # نوع الدفع
    payment_type_label = format_arabic_text("نوع الدفع")
    deposit_label = format_arabic_text("عربون")
    p.drawString(2*cm, y_position, f"Payment Type / {payment_type_label}: Deposit / {deposit_label}")
    y_position -= 1*cm
    
    # التفاصيل المالية
    financial_label = format_arabic_text("التفاصيل المالية")
    p.setFont(font_name, 13)
    p.drawString(2*cm, y_position, f"Financial Details / {financial_label}:")
    y_position -= 0.8*cm
    
    p.setFont(font_name, 11)
    
    # قيمة الطلبية
    order_value_label = format_arabic_text("قيمة الطلبية")
    currency_label = format_arabic_text("دينار ليبي")
    p.drawString(2.5*cm, y_position, f"Order Value / {order_value_label}: {order.total_value:.2f} LYD / {currency_label}")
    y_position -= 0.6*cm
    
    # إجمالي المدفوعات
    total_paid_label = format_arabic_text("إجمالي المدفوعات")
    p.drawString(2.5*cm, y_position, f"Total Paid / {total_paid_label}: {order.total_paid:.2f} LYD / {currency_label}")
    y_position -= 0.6*cm
    
    # المتبقي
    remaining_label = format_arabic_text("المتبقي")
    p.drawString(2.5*cm, y_position, f"Remaining / {remaining_label}: {order.remaining_amount:.2f} LYD / {currency_label}")
    y_position -= 0.8*cm
    
    # هذه الدفعة
    if deposit_amount:
        p.setFont(font_name, 13)
        this_payment_label = format_arabic_text("هذه الدفعة")
        p.drawString(2*cm, y_position, f"This Payment / {this_payment_label}: {deposit_amount:.2f} LYD / {currency_label}")
        y_position -= 1*cm
    
    # حالة الدفع
    p.setFont(font_name, 12)
    payment_status_label = format_arabic_text("حالة الدفع")
    status_ar = format_arabic_text(order.payment_status)
    p.drawString(2*cm, y_position, f"Payment Status / {payment_status_label}: {status_ar}")
    y_position -= 0.8*cm
    
    # المستلم
    received_by_label = format_arabic_text("المستلم")
    p.drawString(2*cm, y_position, f"Received by / {received_by_label}: {current_user.username}")
    y_position -= 1.5*cm
    
    # خط فاصل
    p.line(2*cm, y_position, width - 2*cm, y_position)
    y_position -= 1*cm
    
    # ملاحظة
    note_label = format_arabic_text("هذا إيصال صادر بواسطة الكمبيوتر")
    p.setFont(font_name, 9)
    p.drawString(2*cm, y_position, "This is a computer generated receipt.")
    p.drawString(2*cm, y_position - 0.5*cm, note_label)
    
    # حفظ PDF
    p.showPage()
    p.save()
    
    buffer.seek(0)
    return buffer
```

---

## 📦 الملفات المطلوبة

### 1. تحديث `requirements.txt`:
```txt
arabic-reshaper==3.0.0
python-bidi==0.4.2
```

### 2. إنشاء مجلد الخطوط:
```
kitchen_factory/
  fonts/
    Amiri-Regular.ttf  (اختياري)
    README.txt
```

---

## 🧪 الاختبار

### 1. تثبيت المكتبات:
```bash
pip install arabic-reshaper python-bidi
```

### 2. تشغيل التطبيق واختبار إنشاء إيصال:
- إنشاء طلب جديد
- استلام عربون
- التحقق من عرض النص العربي بشكل صحيح

### 3. النتيجة المتوقعة:
```
Kitchen Factory
Receipt / ايصال قبض  ✅

Order ID / رقم الطلب: 1  ✅
Customer / العميل: asm  ✅
Date / التاريخ: 2025-10-08 17:03  ✅
Payment Type / نوع الدفع: Deposit / عربون  ✅

Financial Details / التفاصيل المالية:  ✅
Order Value / قيمة الطلبية: 10000.00 LYD / دينار ليبي  ✅
Total Paid / إجمالي المدفوعات: 4000.00 LYD / دينار ليبي  ✅
Remaining / المتبقي: 6000.00 LYD / دينار ليبي  ✅

This Payment / هذه الدفعة: 1000.00 LYD / دينار ليبي  ✅

Payment Status / حالة الدفع: دفع جزئي  ✅

Received by / المستلم: admin  ✅
```

---

## ⚠️ ملاحظات مهمة

### 1. الخطوط في Windows:
- إذا كنت على Windows، خط Arial موجود بالفعل ويدعم العربية جزئياً
- المسار: `C:\Windows\Fonts\arial.ttf`
- للحصول على أفضل نتيجة، استخدم خط Amiri

### 2. الأداء:
- `register_arabic_fonts()` يُستدعى مرة واحدة فقط عند إنشاء كل إيصال
- `format_arabic_text()` سريع جداً

### 3. التوافق:
- ✅ يعمل على Windows / Linux / macOS
- ✅ لا يحتاج إلى تعديل قاعدة البيانات
- ✅ لا يؤثر على الوظائف الأخرى

---

## 🔄 خطة التنفيذ

### المرحلة 1: التثبيت السريع (5 دقائق)
1. ✅ تثبيت `arabic-reshaper` و `python-bidi`
2. ✅ إضافة دالة `format_arabic_text()`
3. ✅ إضافة دالة `register_arabic_fonts()`

### المرحلة 2: التحديث (10 دقائق)
4. ✅ تحديث دالة `generate_receipt_pdf()`
5. ✅ استبدال جميع النصوص العربية بـ `format_arabic_text()`

### المرحلة 3: الاختبار (5 دقائق)
6. ✅ اختبار إنشاء إيصال
7. ✅ التحقق من عرض النص العربي

**الوقت الإجمالي**: ~20 دقيقة ⏱️

---

## ✅ الحالة

⏳ **جاهز للتنفيذ** - الحل موثق بالكامل وجاهز للتطبيق

---

**النتيجة المتوقعة**: بعد تطبيق هذا الحل، سيتم عرض جميع النصوص العربية بشكل صحيح في إيصالات PDF! 🎉


# طريقة عمل النظام - نظام إدارة مصنع المطابخ

## نظرة عامة
هذا الملف يحتوي على وصف تفصيلي لكيفية عمل النظام، معماريته، والقواعد الخاصة بمكوناته الأساسية.

---

## نظام إدارة الصالات (Showroom Management System)

### الهدف
ضمان إدارة شاملة للصالات في نظام "فصل الصالات" لتحقيق العزل الكامل للبيانات والصلاحيات بين الصالات المختلفة.

---

### المتطلبات الأساسية

#### أ) الواجهة الإدارية 🖥️
- **وجود CRUD كامل**: إضافة، عرض، تعديل، تعطيل الصالات
- **واجهة مستخدم سهلة**: نماذج واضحة ومنظمة
- **إحصائيات شاملة**: عرض بيانات كل صالة بشكل مفصل
- **صلاحيات محكمة**: المديرون فقط يمكنهم إدارة الصالات

#### ب) البيانات المطلوبة 📋

**الحقول الإلزامية**:
- ✅ اسم الصالة (فريد)

**الحقول الاختيارية**:
- 📌 كود الصالة (قصير وفريد)
- 👤 اسم المدير
- 📞 رقم الهاتف
- 📍 العنوان
- 📝 ملاحظات
- ⚡ حالة التفعيل (نشط/معطل)

#### ج) المسارات المطلوبة 🛣️

```python
# 1. عرض قائمة الصالات
@app.route('/showrooms')  # GET

# 2. إضافة صالة جديدة
@app.route('/showroom/new')  # GET/POST

# 3. تعديل صالة
@app.route('/showroom/<id>/edit')  # GET/POST

# 4. عرض تفاصيل صالة
@app.route('/showroom/<id>')  # GET

# 5. تعطيل/تفعيل صالة
@app.route('/showroom/<id>/toggle_active')  # POST
```

#### د) القوالب المطلوبة 📄
- `showrooms.html` - قائمة الصالات
- `new_showroom.html` - نموذج إضافة صالة
- `edit_showroom.html` - نموذج تعديل صالة
- `showroom_detail.html` - تفاصيل وإحصائيات الصالة

#### هـ) الإحصائيات المطلوبة 📊

لكل صالة يجب عرض:
- 🔢 إجمالي الطلبات (الكل، المفتوحة، المنتهية)
- 👥 عدد الموظفين (الكل، النشطين)
- 📦 عدد المواد (الكل، النشطة)
- 💰 إجمالي الإيرادات
- 💳 عدد الدفعات
- 📋 آخر الطلبات (آخر 5-10)

#### و) التحقق والأمان 🔒

```python
# 1. التحقق من عدم التكرار
if Showroom.query.filter_by(name=name).first():
    flash('اسم الصالة موجود بالفعل', 'danger')

# 2. التحقق من الصلاحية
if current_user.role != 'مدير':
    flash('ليس لديك صلاحية', 'danger')

# 3. التحقق من عدم الحذف
if showroom.deleted_at:
    flash('هذه الصالة محذوفة', 'danger')
```

#### ز) التكامل مع النظام 🔗
- **في Sidebar**: رابط "إدارة الصالات" في قائمة المدير
- **في نموذج المستخدم**: اختيار الصالة عند إنشاء مستخدم جديد
- **في نموذج الطلب**: اختيار الصالة عند إنشاء طلب (للمديرين)
- **في التقارير**: فلترة حسب الصالة

#### ح) الفوائد ✅
- **سهولة التوسع**: إضافة صالات جديدة بدون تدخل يدوي
- **رؤية شاملة**: المديرون يرون جميع الصالات وإحصائياتها
- **مرونة الإدارة**: تعطيل/تفعيل الصالات حسب الحاجة
- **تنظيم البيانات**: كل صالة مفصولة بشكل كامل

#### ط) ملاحظات مهمة ⚠️
- **لا تسمح بحذف صالة** لها بيانات مرتبطة (استخدم Soft Delete)
- **تأكد من وجود صالة واحدة افتراضية** على الأقل
- **اختبر الصلاحيات** بشكل جيد لمنع التسريب بين الصالات
- **وثّق التغييرات** في Change log عند إضافة/تعديل ميزات الصالات

---

## معمارية النظام (System Architecture)

### 1. طبقة قاعدة البيانات (Database Layer)

#### النماذج الأساسية (Core Models):
- `Showroom` - إدارة الصالات
- `User` - المستخدمون والصلاحيات
- `Customer` - العملاء (مشتركون بين الصالات)
- `Order` - الطلبات (مرتبطة بصالة محددة)
- `Material` - المواد (مرتبطة بصالة محددة)
- `Payment` - الدفعات
- `OrderCost` - التكاليف
- `Stage` - مراحل الطلب

#### العلاقات الرئيسية:
```
Showroom (1) ──── (N) User
Showroom (1) ──── (N) Order
Showroom (1) ──── (N) Material
Order (1) ──── (N) Payment
Order (1) ──── (N) OrderCost
Order (N) ──── (1) Customer
```

### 2. طبقة المنطق (Business Logic Layer)

#### Helper Functions:
- `get_scoped_query(model, user)` - العزل التلقائي للبيانات
- `require_showroom_access(f)` - ديكوريتر للحماية
- `get_user_showroom_id()` - الحصول على صالة المستخدم
- `get_all_showrooms()` - جلب جميع الصالات

### 3. طبقة العرض (Presentation Layer)

#### القوالب (Templates):
- **القوالب الأساسية**: `base.html`, `dashboard.html`, `index.html`
- **قوالب الطلبات**: `orders.html`, `order_detail.html`, `new_order.html`
- **قوالب المواد**: `materials.html`, `new_material.html`, `edit_material.html`
- **قوالب المستخدمين**: `users.html`, `new_user.html`, `edit_user.html`
- **قوالب الصالات**: `showrooms.html`, `new_showroom.html`, `edit_showroom.html`, `showroom_detail.html`
- **قوالب التقارير**: `reports.html`, `reports/*.html`

---

## مبادئ العزل بين الصالات

### 1. عزل البيانات (Data Isolation)
- كل طلب مرتبط بصالة واحدة فقط
- كل مادة مرتبطة بصالة واحدة فقط
- جميع العمليات تستخدم `showroom_id` للفلترة

### 2. عزل الصلاحيات (Permission Isolation)
- **المديرون**: وصول كامل لجميع الصالات
- **موظفو الاستقبال**: وصول لصالتهم فقط
- **التحقق التلقائي**: استخدام `@require_showroom_access`

### 3. البيانات المشتركة (Shared Data)
- **العملاء**: مشتركون بين جميع الصالات
- **السبب**: العميل قد يزور أكثر من صالة

---

## تدفق العمليات (Workflow)

### 1. إنشاء طلب جديد
```
المستخدم يسجل الدخول
    ↓
اختيار الصالة (للمديرين) أو استخدام صالته (للموظفين)
    ↓
إدخال بيانات الطلب
    ↓
حفظ الطلب مع showroom_id
    ↓
إنشاء مراحل الطلب تلقائياً
```

### 2. استلام عربون
```
المستخدم يفتح تفاصيل الطلب
    ↓
اختيار "استلام عربون"
    ↓
إدخال قيمة العربون وطريقة الدفع
    ↓
حفظ الدفعة مع showroom_id من الطلب
    ↓
تحديث مرحلة "استلام العربون" إلى 100%
    ↓
إصدار إيصال PDF تلقائياً
```

### 3. إدارة الصالات
```
المدير يسجل الدخول
    ↓
الانتقال إلى "إدارة الصالات"
    ↓
عرض قائمة الصالات مع الإحصائيات
    ↓
إضافة/تعديل/تعطيل الصالات
```

---

## الأمان والحماية (Security)

### 1. حماية المسارات
```python
@login_required  # التحقق من تسجيل الدخول
@require_showroom_access  # التحقق من صلاحية الوصول للصالة
def edit_order(order_id):
    # ...
```

### 2. Soft Delete
- المستخدمون لا يُحذفون فعلياً، بل يُعطّلون (`is_active=False`)
- الصالات تُحذف بـ Soft Delete (`deleted_at`)

### 3. Audit Trail
- تتبع آخر تسجيل دخول (`last_login`)
- تتبع تحديثات الأسعار (`price_updated_at`, `price_updated_by`)
- Timestamps تلقائية (`created_at`, `updated_at`)

---

## الأداء والتحسينات (Performance)

### Indexes المطبقة
```sql
-- على جدول orders
CREATE INDEX idx_showroom_status ON orders(showroom_id, status);
CREATE INDEX idx_showroom_date ON orders(showroom_id, order_date);
CREATE INDEX idx_customer_showroom ON orders(customer_id, showroom_id);

-- على جدول customers
CREATE INDEX idx_customer_phone ON customer(phone);
CREATE INDEX idx_customer_name ON customer(name);
```

### Best Practices
- استخدام `get_scoped_query()` بدلاً من Query يدوية
- Lazy loading للعلاقات
- Pagination للقوائم الطويلة

---

## التوسعات المستقبلية

### Phase 2 - نظام الموردين
- إضافة نموذج `Supplier`
- إضافة نموذج `PurchaseInvoice`
- ربط الموردين بالصالات
- تتبع الفواتير والمدفوعات

### Phase 3 - التقارير المتقدمة
- تقارير مقارنة بين الصالات
- تقارير الأداء الشهرية
- تحليلات البيانات
- Export إلى Excel/PDF

### Phase 4 - نظام الإشعارات
- إشعارات الطلبات المتأخرة
- إشعارات نقص المواد
- إشعارات الدفعات المستحقة

---

## الخلاصة

نظام إدارة مصنع المطابخ هو نظام شامل يوفر:
- ✅ عزل كامل بين الصالات
- ✅ إدارة متكاملة للطلبات والمواد
- ✅ نظام صلاحيات محكم
- ✅ تقارير وإحصائيات شاملة
- ✅ واجهة مستخدم عصرية وسهلة

**الحالة الحالية**: النظام جاهز للإنتاج مع جميع المميزات الأساسية مطبقة ومختبرة.


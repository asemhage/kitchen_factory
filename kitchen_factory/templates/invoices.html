{% extends "base.html" %}

{% block title %}فواتير الشراء{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- العنوان والإحصائيات -->
    <div class="row mb-4">
        <div class="col-md-12">
            <h2><i class="fas fa-file-invoice-dollar"></i> فواتير الشراء</h2>
        </div>
    </div>

    <!-- بطاقات الإحصائيات -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-file-invoice"></i> إجمالي الفواتير</h5>
                    <h3>{{ stats.total_invoices }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-coins"></i> إجمالي المبالغ</h5>
                    <h3>{{ "%.2f"|format(stats.total_amount) }} د.ل</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-check-circle"></i> المدفوع</h5>
                    <h3>{{ "%.2f"|format(stats.total_paid) }} د.ل</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-dark bg-warning">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-exclamation-triangle"></i> المتبقي</h5>
                    <h3>{{ "%.2f"|format(stats.total_remaining) }} د.ل</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- أزرار الإجراءات -->
    <div class="row mb-3">
        <div class="col-md-12">
            <a href="{{ url_for('new_invoice') }}" class="btn btn-primary">
                <i class="fas fa-plus"></i> إضافة فاتورة جديدة
            </a>
            {% if stats.overdue_count > 0 %}
            <span class="badge badge-danger ml-2" style="font-size: 1em;">
                <i class="fas fa-exclamation-circle"></i> {{ stats.overdue_count }} فاتورة متأخرة
            </span>
            {% endif %}
        </div>
    </div>

    <!-- جدول الفواتير -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-list"></i> قائمة الفواتير</h5>
                </div>
                <div class="card-body">
                    <table class="table table-striped table-hover" id="invoicesTable">
                        <thead class="thead-dark">
                            <tr>
                                <th>رقم الفاتورة</th>
                                <th>المورد</th>
                                <th>التاريخ</th>
                                <!-- تم إزالة تاريخ الاستحقاق -->
                                <th>المبلغ الكلي</th>
                                <th>المدفوع</th>
                                <th>المتبقي</th>
                                <th>الحالة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for invoice in invoices %}
                            <tr>
                                <td>
                                    <strong>{{ invoice.invoice_number }}</strong>
                                </td>
                                <td>
                                    <a href="{{ url_for('supplier_detail', supplier_id=invoice.supplier.id) }}">
                                        {{ invoice.supplier.name }}
                                    </a>
                                </td>
                                <td>{{ invoice.invoice_date.strftime('%Y-%m-%d') }}</td>
                                <td>{{ "%.2f"|format(invoice.final_amount) }} د.ل</td>
                                <td>{{ "%.2f"|format(invoice.paid_amount) }} د.ل</td>
                                <td>
                                    <strong class="{% if invoice.remaining_amount > 0 %}text-warning{% else %}text-success{% endif %}">
                                        {{ "%.2f"|format(invoice.remaining_amount) }} د.ل
                                    </strong>
                                </td>
                                <td>
                                    {% if invoice.status == 'paid' %}
                                        <span class="badge badge-success">مدفوعة</span>
                                    {% elif invoice.status == 'partial' %}
                                        <span class="badge badge-warning">مدفوعة جزئياً</span>
                                    {% elif invoice.status == 'cancelled' %}
                                        <span class="badge badge-danger">ملغاة</span>
                                    {% elif invoice.status == 'overdue' %}
                                        <span class="badge badge-danger">متأخرة</span>
                                    {% else %}
                                        <span class="badge badge-secondary">مفتوحة</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ url_for('invoice_detail', invoice_id=invoice.id) }}" 
                                       class="btn btn-sm btn-info" title="عرض التفاصيل">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    {% if invoice.remaining_amount > 0 and invoice.status != 'cancelled' %}
                                    <a href="{{ url_for('add_invoice_payment', invoice_id=invoice.id) }}" 
                                       class="btn btn-sm btn-success" title="تسجيل دفعة">
                                        <i class="fas fa-money-bill-wave"></i>
                                    </a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    $('#invoicesTable').DataTable({
        "language": {
            "url": "//cdn.datatables.net/plug-ins/1.10.24/i18n/Arabic.json"
        },
        "order": [[2, "desc"]],  // ترتيب حسب التاريخ
        "pageLength": 25
    });
});
</script>
{% endblock %}



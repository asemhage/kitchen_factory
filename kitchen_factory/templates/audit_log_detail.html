{% extends "base.html" %}

{% block title %}تفاصيل سجل التدقيق - نظام إدارة مصنع المطابخ{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-file-alt"></i> تفاصيل سجل التدقيق #{{ log.id }}</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{{ url_for('audit_log_list') }}" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-arrow-right"></i> العودة
            </a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">معلومات العملية</h5>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-3">العملية:</dt>
                    <dd class="col-sm-9">
                        {% if log.action == 'create' %}
                        <span class="badge bg-success">إنشاء (Create)</span>
                        {% elif log.action == 'update' %}
                        <span class="badge bg-warning">تحديث (Update)</span>
                        {% elif log.action == 'delete' %}
                        <span class="badge bg-danger">حذف (Delete)</span>
                        {% elif log.action == 'cancel' %}
                        <span class="badge bg-secondary">إلغاء (Cancel)</span>
                        {% else %}
                        <span class="badge bg-info">{{ log.action }}</span>
                        {% endif %}
                    </dd>

                    <dt class="col-sm-3">الجدول:</dt>
                    <dd class="col-sm-9"><code>{{ log.table_name }}</code></dd>

                    <dt class="col-sm-3">رقم السجل:</dt>
                    <dd class="col-sm-9"><strong>{{ log.record_id }}</strong></dd>

                    {% if log.field_name %}
                    <dt class="col-sm-3">الحقل:</dt>
                    <dd class="col-sm-9"><code>{{ log.field_name }}</code></dd>
                    {% endif %}

                    <dt class="col-sm-3">القيمة القديمة:</dt>
                    <dd class="col-sm-9">
                        {% if log.old_value %}
                        <pre class="bg-light p-2 border rounded">{{ log.old_value }}</pre>
                        {% else %}
                        <span class="text-muted">-</span>
                        {% endif %}
                    </dd>

                    <dt class="col-sm-3">القيمة الجديدة:</dt>
                    <dd class="col-sm-9">
                        {% if log.new_value %}
                        <pre class="bg-light p-2 border rounded">{{ log.new_value }}</pre>
                        {% else %}
                        <span class="text-muted">-</span>
                        {% endif %}
                    </dd>

                    {% if log.reason %}
                    <dt class="col-sm-3">السبب:</dt>
                    <dd class="col-sm-9">{{ log.reason }}</dd>
                    {% endif %}

                    {% if log.notes %}
                    <dt class="col-sm-3">ملاحظات:</dt>
                    <dd class="col-sm-9">{{ log.notes }}</dd>
                    {% endif %}
                </dl>
            </div>
        </div>

        {% if related_logs %}
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0">سجلات مرتبطة (نفس الجدول والسجل)</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <thead>
                            <tr>
                                <th>الوقت</th>
                                <th>المستخدم</th>
                                <th>العملية</th>
                                <th>الحقل</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for related_log in related_logs %}
                            <tr>
                                <td><small>{{ related_log.timestamp.strftime('%Y-%m-%d %H:%M') }}</small></td>
                                <td>{{ related_log.user_name or 'نظام' }}</td>
                                <td>
                                    {% if related_log.action == 'create' %}
                                    <span class="badge bg-success">إنشاء</span>
                                    {% elif related_log.action == 'update' %}
                                    <span class="badge bg-warning">تحديث</span>
                                    {% elif related_log.action == 'delete' %}
                                    <span class="badge bg-danger">حذف</span>
                                    {% else %}
                                    <span class="badge bg-info">{{ related_log.action }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ related_log.field_name or '-' }}</td>
                                <td>
                                    <a href="{{ url_for('audit_log_detail', log_id=related_log.id) }}" 
                                       class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <div class="col-md-4">
        <div class="card bg-light">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-user"></i> معلومات المستخدم</h6>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-5">المستخدم:</dt>
                    <dd class="col-sm-7"><strong>{{ log.user_name or 'نظام' }}</strong></dd>

                    {% if log.user %}
                    <dt class="col-sm-5">ID:</dt>
                    <dd class="col-sm-7">{{ log.user_id }}</dd>
                    {% endif %}

                    {% if log.showroom %}
                    <dt class="col-sm-5">الصالة:</dt>
                    <dd class="col-sm-7">{{ log.showroom.name }}</dd>
                    {% endif %}

                    <dt class="col-sm-5">عنوان IP:</dt>
                    <dd class="col-sm-7">
                        <code>{{ log.ip_address or '-' }}</code>
                    </dd>

                    <dt class="col-sm-5">التوقيت:</dt>
                    <dd class="col-sm-7">
                        {{ log.timestamp.strftime('%Y-%m-%d') }}<br>
                        <strong>{{ log.timestamp.strftime('%H:%M:%S') }}</strong>
                    </dd>
                </dl>
            </div>
        </div>
    </div>
</div>

{% endblock %}


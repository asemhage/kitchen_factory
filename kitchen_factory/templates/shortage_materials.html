{% extends "base.html" %}

{% block title %}المواد الناقصة{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2>
                <i class="fas fa-exclamation-triangle text-warning"></i>
                قائمة المواد الناقصة في الطلبيات
            </h2>
            <p class="text-muted">
                جميع المواد التي تحتاج إلى شراء أو إكمال من المخزن
            </p>
        </div>
        <div class="col-md-4 text-right">
            <a href="{{ url_for('materials') }}" class="btn btn-info">
                <i class="fas fa-warehouse"></i> المخزن
            </a>
            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                <i class="fas fa-home"></i> الرئيسية
            </a>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card bg-danger text-white">
                <div class="card-body text-center">
                    <h3>{{ shortage_items|length }}</h3>
                    <p class="mb-0">إجمالي السجلات الناقصة</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-warning text-dark">
                <div class="card-body text-center">
                    <h3>{{ material_summary|length }}</h3>
                    <p class="mb-0">عدد المواد المختلفة</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h3>{{ "%.0f"|format(material_summary.values()|map(attribute='total_value')|sum) }}</h3>
                    <p class="mb-0">القيمة الإجمالية (د.ل)</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Material Summary Section -->
    <div class="card mb-4">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0">
                <i class="fas fa-chart-bar"></i>
                ملخص المواد الناقصة (مجمّع)
            </h5>
        </div>
        <div class="card-body">
            {% if material_summary %}
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="thead-dark">
                        <tr>
                            <th>#</th>
                            <th>المادة</th>
                            <th>الرمز</th>
                            <th>الوحدة</th>
                            <th>إجمالي الناقص</th>
                            <th>عدد الطلبيات</th>
                            <th>القيمة التقديرية</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for mat_id, info in material_summary.items() %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td>
                                <strong>{{ info.material.name }}</strong>
                                <br><small class="text-muted">المتاح: {{ info.material.quantity_available }}</small>
                            </td>
                            <td>{{ info.material.code }}</td>
                            <td>{{ info.material.unit }}</td>
                            <td class="text-danger">
                                <strong>{{ info.total_shortage }}</strong>
                            </td>
                            <td>
                                <span class="badge badge-info">{{ info.orders_count }}</span>
                            </td>
                            <td>{{ "%.2f"|format(info.total_value) }} د.ل</td>
                            <td>
                                <button class="btn btn-sm btn-primary" 
                                        onclick="showOrders({{ mat_id }})"
                                        data-toggle="collapse" 
                                        data-target="#orders_{{ mat_id }}">
                                    <i class="fas fa-eye"></i> التفاصيل
                                </button>
                            </td>
                        </tr>
                        <!-- Expandable orders list -->
                        <tr class="collapse" id="orders_{{ mat_id }}">
                            <td colspan="8" class="bg-light">
                                <div class="p-3">
                                    <h6><i class="fas fa-list-ul"></i> الطلبيات التي تحتاج هذه المادة:</h6>
                                    <ul class="list-group">
                                        {% for order_info in info.orders %}
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>طلبية #{{ order_info.order.id }}</strong>
                                                - {{ order_info.order.customer.name }}
                                                <br><small class="text-muted">الحالة: {{ order_info.order.status }}</small>
                                            </div>
                                            <div>
                                                <span class="badge badge-danger badge-pill">
                                                    {{ order_info.quantity }} {{ info.material.unit }}
                                                </span>
                                                <a href="{{ url_for('order_materials', order_id=order_info.order.id) }}" 
                                                   class="btn btn-sm btn-outline-primary ml-2">
                                                    <i class="fas fa-external-link-alt"></i>
                                                </a>
                                            </div>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-success text-center">
                <i class="fas fa-check-circle fa-3x mb-3"></i>
                <h4>لا توجد مواد ناقصة!</h4>
                <p>جميع المواد المطلوبة متوفرة ومخصومة بالكامل.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Detailed List Section -->
    {% if shortage_items %}
    <div class="card">
        <div class="card-header bg-danger text-white">
            <h5 class="mb-0">
                <i class="fas fa-list"></i>
                القائمة التفصيلية
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-bordered" id="shortageTable">
                    <thead class="thead-light">
                        <tr>
                            <th>#</th>
                            <th>الطلبية</th>
                            <th>العميل</th>
                            <th>المادة</th>
                            <th>المطلوب</th>
                            <th>المخصوم</th>
                            <th>الناقص</th>
                            <th>الحالة</th>
                            <th>تاريخ الإضافة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in shortage_items %}
                        <tr class="{% if item.status == 'partial' %}table-warning{% else %}table-danger{% endif %}">
                            <td>{{ loop.index }}</td>
                            <td>
                                <a href="{{ url_for('order_detail', order_id=item.order.id) }}">
                                    #{{ item.order.id }}
                                </a>
                            </td>
                            <td>{{ item.order.customer.name }}</td>
                            <td>
                                <strong>{{ item.material.name }}</strong>
                                <br><small class="text-muted">{{ item.material.code }}</small>
                            </td>
                            <td>{{ item.quantity_needed }} {{ item.material.unit }}</td>
                            <td>{{ item.quantity_consumed }} {{ item.material.unit }}</td>
                            <td class="text-danger">
                                <strong>{{ item.quantity_shortage }} {{ item.material.unit }}</strong>
                            </td>
                            <td>
                                {% if item.status == 'partial' %}
                                <span class="badge badge-warning">جزئي</span>
                                {% else %}
                                <span class="badge badge-danger">معلق</span>
                                {% endif %}
                            </td>
                            <td>{{ item.added_at.strftime('%Y-%m-%d %H:%M') if item.added_at else '-' }}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <a href="{{ url_for('order_materials', order_id=item.order.id) }}" 
                                       class="btn btn-primary" title="إدارة المواد">
                                        <i class="fas fa-tasks"></i>
                                    </a>
                                    {% if item.material.quantity_available > 0 %}
                                    <button class="btn btn-success" 
                                            onclick="completeShortage({{ item.id }}, '{{ item.material.name }}')"
                                            title="إكمال النقص">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    {% else %}
                                    <button class="btn btn-secondary" disabled title="غير متوفر">
                                        <i class="fas fa-ban"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Hidden Form for Complete Shortage -->
<form id="completeShortageForm" method="POST" style="display: none;">
</form>

<script>
function showOrders(materialId) {
    // Bootstrap collapse will handle the toggle
    console.log('Showing orders for material:', materialId);
}

function completeShortage(materialId, materialName) {
    if (confirm(`هل تريد إكمال نقص "${materialName}"؟\n\nسيتم خصم الكمية المتاحة من المخزن.`)) {
        const form = document.getElementById('completeShortageForm');
        form.action = `/order_material/${materialId}/complete_shortage`;
        form.submit();
    }
}

// DataTables initialization (if available)
$(document).ready(function() {
    if ($.fn.DataTable) {
        $('#shortageTable').DataTable({
            "language": {
                "url": "//cdn.datatables.net/plug-ins/1.10.24/i18n/Arabic.json"
            },
            "order": [[8, "desc"]], // Sort by date
            "pageLength": 25
        });
    }
});
</script>
{% endblock %}



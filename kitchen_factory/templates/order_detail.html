{% extends "base.html" %}

{% block title %}ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ #{{ order.id }} - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…ØµÙ†Ø¹ Ø§Ù„Ù…Ø·Ø§Ø¨Ø®{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ #{{ order.id }}</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{{ url_for('orders') }}" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø·Ù„Ø¨Ø§Øª
            </a>
            {% if current_user.role in ['Ù…Ø¯ÙŠØ±', 'Ù…ÙˆØ¸Ù Ø§Ø³ØªÙ‚Ø¨Ø§Ù„'] %}
            <a href="{{ url_for('edit_order', order_id=order.id) }}" class="btn btn-sm btn-warning">
                <i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„
            </a>
            
            <!-- Ø£Ø²Ø±Ø§Ø± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ -->
            {% set design_stage = order.stages|selectattr("stage_name", "equalto", "ØªØµÙ…ÙŠÙ…")|first %}
            {% set deposit_stage = order.stages|selectattr("stage_name", "equalto", "Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ†")|first %}
            
            <!-- Ø²Ø± Ø¥ÙƒØªÙ…Ø§Ù„ Ø§Ù„ØªØµÙ…ÙŠÙ… -->
            {% if design_stage and design_stage.start_date and design_stage.progress < 100 %}
            <form method="POST" action="{{ url_for('complete_design_stage', order_id=order.id) }}" style="display: inline-block;">
                <button type="submit" class="btn btn-sm btn-primary" onclick="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥ÙƒØªÙ…Ø§Ù„ Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØµÙ…ÙŠÙ…ØŸ Ø³ÙŠØªÙ… Ø¨Ø¯Ø¡ Ù…Ø±Ø­Ù„Ø© Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ† ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.')">
                    <i class="fas fa-check"></i> Ø¥ÙƒØªÙ…Ø§Ù„ Ø§Ù„ØªØµÙ…ÙŠÙ…
                </button>
            </form>
            {% endif %}
            
            <!-- Ø²Ø± Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ† (ÙŠÙ‚ÙˆÙ… Ø¨Ø¥ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ù…Ø±Ø­Ù„Ø© ÙˆØ¥ØµØ¯Ø§Ø± Ø¥ÙŠØµØ§Ù„) -->
            {% if design_stage and design_stage.progress == 100 and deposit_stage and deposit_stage.progress < 100 %}
            <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#receiveDepositModal">
                <i class="fas fa-money-bill-wave"></i> Ø§Ø³ØªÙ„Ø§Ù…
            </button>
            {% endif %}
            {% endif %}
            {% if current_user.role in ['Ù…Ø¯ÙŠØ±', 'Ù…Ø³Ø¤ÙˆÙ„ Ø¥Ù†ØªØ§Ø¬', 'Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª'] %}
            <a href="{{ url_for('order_stages', order_id=order.id) }}" class="btn btn-sm btn-primary">
                <i class="fas fa-tasks"></i> Ø§Ù„Ù…Ø±Ø§Ø­Ù„
            </a>
            {% endif %}
            {% if current_user.role in ['Ù…Ø¯ÙŠØ±', 'Ù…Ø³Ø¤ÙˆÙ„ Ø¥Ù†ØªØ§Ø¬', 'Ù…Ø³Ø¤ÙˆÙ„ Ù…Ø®Ø²Ù†', 'Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª'] %}
            <a href="{{ url_for('order_costs', order_id=order.id) }}" class="btn btn-sm btn-info">
                <i class="fas fa-money-bill-wave"></i> Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ
            </a>
            <a href="{{ url_for('order_materials', order_id=order.id) }}" class="btn btn-sm btn-success">
                <i class="fas fa-boxes"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¯
            </a>
            {% endif %}
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ù„Ø¨</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p><strong>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</strong> {{ order.id }}</p>
                        <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨:</strong> {{ order.order_date.strftime('%Y-%m-%d') }}</p>
                        <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…:</strong> {{ order.delivery_date.strftime('%Y-%m-%d') if order.delivery_date else 'Ù„Ù… ÙŠØ­Ø¯Ø¯ Ø¨Ø¹Ø¯' }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù…ØªØ§Ø±:</strong> {{ order.meters }}</p>
                        <p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong>
                            {% if order.status == 'Ù…ÙØªÙˆØ­' %}
                            <span class="badge bg-info">{{ order.status }}</span>
                            {% elif order.status == 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°' %}
                            <span class="badge bg-warning">{{ order.status }}</span>
                            {% elif order.status == 'Ù…ÙƒØªÙ…Ù„' %}
                            <span class="badge bg-success">{{ order.status }}</span>
                            {% elif order.status == 'Ù…Ø³Ù„Ù‘Ù…' %}
                            <span class="badge bg-primary">{{ order.status }}</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ order.status }}</span>
                            {% endif %}
                        </p>
                        
                        <!-- Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© - Ù„Ù„Ù…Ø¯ÙŠØ± ÙˆÙ…ÙˆØ¸Ù Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ÙÙ‚Ø· -->
                        {% if current_user.role in ['Ù…Ø¯ÙŠØ±', 'Ù…ÙˆØ¸Ù Ø§Ø³ØªÙ‚Ø¨Ø§Ù„'] %}
                        <div class="mt-3 p-3 bg-light rounded">
                            <h6><strong>Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©:</strong></h6>
                            <p class="mb-1"><strong>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø·Ù„Ø¨ÙŠØ©:</strong> {{ "%.2f"|format(order.total_value) }} Ø¯ÙŠÙ†Ø§Ø± Ù„ÙŠØ¨ÙŠ</p>
                            <p class="mb-1"><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª:</strong> {{ "%.2f"|format(order.total_paid) }} Ø¯ÙŠÙ†Ø§Ø± Ù„ÙŠØ¨ÙŠ</p>
                            <p class="mb-1"><strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</strong> 
                                <span class="{% if order.remaining_amount <= 0 %}text-success{% else %}text-warning{% endif %}">
                                    {{ "%.2f"|format(order.remaining_amount) }} Ø¯ÙŠÙ†Ø§Ø± Ù„ÙŠØ¨ÙŠ
                                </span>
                            </p>
                            <p class="mb-0"><strong>Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹:</strong> 
                                {% if order.payment_status == 'Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„' %}
                                <span class="badge bg-success">{{ order.payment_status }}</span>
                                {% elif order.payment_status == 'Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹' %}
                                <span class="badge bg-warning">{{ order.payment_status }}</span>
                                {% elif order.payment_status == 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹' %}
                                <span class="badge bg-danger">{{ order.payment_status }}</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ order.payment_status }}</span>
                                {% endif %}
                            </p>
                        </div>
                        {% endif %}
                        
                        {% if current_user.role != 'Ù…ÙˆØ¸Ù Ø§Ø³ØªÙ‚Ø¨Ø§Ù„' %}
                        <p class="mt-2"><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ:</strong> {{ order.total_price }} Ø¯ÙŠÙ†Ø§Ø± Ù„ÙŠØ¨ÙŠ</p>
                        {% endif %}
                    </div>
                </div>
                {% if order.notes %}
                <div class="mb-3">
                    <p><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> {{ order.notes }}</p>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ø·Ù„Ø¨</h5>
            </div>
            <div class="card-body">
                {% if order_stages %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th>Ø§Ù„ØªÙ‚Ø¯Ù…</th>
                                <th>Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th>
                                <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stage in order_stages %}
                            <tr>
                                <td>{{ stage.stage_name }}</td>
                                <td>
                                    {% if stage.progress == 0 and not stage.start_date %}
                                    <span class="badge bg-secondary">Ù„Ù… ØªØ¨Ø¯Ø£</span>
                                    {% elif stage.progress > 0 and stage.progress < 100 %}
                                    <span class="badge bg-warning">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</span>
                                    {% elif stage.progress == 100 %}
                                    <span class="badge bg-success">Ù…ÙƒØªÙ…Ù„Ø©</span>
                                    {% elif stage.start_date and stage.progress == 0 %}
                                    <span class="badge bg-info">Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø¨Ø¯Ø¡</span>
                                    {% else %}
                                    <span class="badge bg-info">{{ stage.status or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</span>
                                    {% endif %}
                                    
                                    <!-- Ø¥Ø´Ø§Ø±Ø§Øª Ø®Ø§ØµØ© Ù„Ù„Ù…Ø±Ø§Ø­Ù„ Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ -->
                                    {% if current_user.role in ['Ù…Ø¯ÙŠØ±', 'Ù…ÙˆØ¸Ù Ø§Ø³ØªÙ‚Ø¨Ø§Ù„'] %}
                                        {% set design_stage = order.stages|selectattr("stage_name", "equalto", "ØªØµÙ…ÙŠÙ…")|first %}
                                        {% set deposit_stage = order.stages|selectattr("stage_name", "equalto", "Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ†")|first %}
                                        
                                        {% if stage.stage_name == 'ØªØµÙ…ÙŠÙ…' and stage.start_date and stage.progress < 100 %}
                                        <br><small class="text-primary"><i class="fas fa-check-circle"></i> ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¥ÙƒØªÙ…Ø§Ù„</small>
                                        {% elif stage.stage_name == 'Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ†' and design_stage and design_stage.progress == 100 and stage.progress < 100 %}
                                        <br><small class="text-success"><i class="fas fa-money-bill-wave"></i> ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</small>
                                        {% endif %}
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar" role="progressbar" style="width: {{ stage.progress }}%"
                                             aria-valuenow="{{ stage.progress }}" aria-valuemin="0" aria-valuemax="100">
                                            {{ stage.progress }}%
                                        </div>
                                    </div>
                                </td>
                                <td>{{ stage.assigned_to or 'Ù„Ù… ÙŠØ­Ø¯Ø¯ Ø¨Ø¹Ø¯' }}</td>
                                <td>{{ stage.notes or '-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-center text-muted">Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ø¥Ù†ØªØ§Ø¬ Ø¨Ø¹Ø¯</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h5>
            </div>
            <div class="card-body">
                <p><strong>Ø§Ù„Ø§Ø³Ù…:</strong> {{ order.customer.name }}</p>
                <p><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> {{ order.customer.phone or 'Ù„Ù… ÙŠØ­Ø¯Ø¯' }}</p>
                <p><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> {{ order.customer.address or 'Ù„Ù… ÙŠØ­Ø¯Ø¯' }}</p>
                <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©:</strong> {{ order.customer.orders|length - 1 }}</p>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ÙÙ‚Ø©</h5>
                {% if current_user.role in ['Ù…Ø¯ÙŠØ±', 'Ù…ÙˆØ¸Ù Ø§Ø³ØªÙ‚Ø¨Ø§Ù„'] %}
                    {% set deposit_stage = order.stages|selectattr("stage_name", "equalto", "Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ†")|first %}
                    {% set can_manage_files = current_user.role == 'Ù…Ø¯ÙŠØ±' or (current_user.role == 'Ù…ÙˆØ¸Ù Ø§Ø³ØªÙ‚Ø¨Ø§Ù„' and (not deposit_stage or deposit_stage.progress < 100)) %}
                    {% if can_manage_files %}
                    <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addDocumentModal">
                        <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙÙ‚
                    </button>
                    {% else %}
                    <button type="button" class="btn btn-sm btn-secondary" disabled title="Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙÙ‚Ø§Øª Ø¨Ø¹Ø¯ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ†">
                        <i class="fas fa-lock"></i> Ù…Ù‚ÙÙ„
                    </button>
                    {% endif %}
                {% endif %}
            </div>
            <div class="card-body">
                {% if order.documents %}
                <ul class="list-group">
                    {% for document in order.documents %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>ğŸ“ {{ document.file_path.split('_', 3)[-1] if '_' in document.file_path else document.file_path }}</strong>
                            <br><small class="text-muted">{{ document.file_path }}</small>
                        </div>
                        <div class="btn-group">
                            <a href="{{ url_for('download_file', filename=document.file_path) }}" class="btn btn-sm btn-primary">
                                <i class="fas fa-download"></i> ØªØ­Ù…ÙŠÙ„
                            </a>
                            {% if current_user.role in ['Ù…Ø¯ÙŠØ±', 'Ù…ÙˆØ¸Ù Ø§Ø³ØªÙ‚Ø¨Ø§Ù„'] %}
                                {% set deposit_stage = order.stages|selectattr("stage_name", "equalto", "Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ†")|first %}
                                {% set can_manage_files = current_user.role == 'Ù…Ø¯ÙŠØ±' or (current_user.role == 'Ù…ÙˆØ¸Ù Ø§Ø³ØªÙ‚Ø¨Ø§Ù„' and (not deposit_stage or deposit_stage.progress < 100)) %}
                                {% if can_manage_files %}
                                <form method="POST" action="{{ url_for('delete_document', order_id=order.id, document_id=document.id) }}" style="display: inline-block;">
                                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±ÙÙ‚ØŸ')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                                {% else %}
                                <button type="button" class="btn btn-sm btn-secondary" disabled title="Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ù…Ø±ÙÙ‚Ø§Øª Ø¨Ø¹Ø¯ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ†">
                                    <i class="fas fa-lock"></i>
                                </button>
                                {% endif %}
                            {% endif %}
                        </div>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª Ù…Ø±ÙÙ‚Ø©</p>
                {% endif %}
            </div>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª -->
        {% if current_user.role in ['Ù…Ø¯ÙŠØ±', 'Ù…ÙˆØ¸Ù Ø§Ø³ØªÙ‚Ø¨Ø§Ù„'] %}
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</h5>
                {% if order.remaining_amount > 0 %}
                <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addPaymentModal">
                    <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø©
                </button>
                {% endif %}
            </div>
            <div class="card-body">
                {% if order.payments %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                <th>Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©</th>
                                <th>Ø§Ù„Ù…Ø³ØªÙ„Ù…</th>
                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for payment in order.payments %}
                            <tr>
                                <td>{{ payment.payment_date.strftime('%Y-%m-%d') }}</td>
                                <td>
                                    {% if payment.payment_type == 'Ø¹Ø±Ø¨ÙˆÙ†' %}
                                    <span class="badge bg-success">{{ payment.payment_type }}</span>
                                    {% else %}
                                    <span class="badge bg-info">{{ payment.payment_type }}</span>
                                    {% endif %}
                                </td>
                                <td><strong>{{ "%.2f"|format(payment.amount) }} Ø¯ÙŠÙ†Ø§Ø± Ù„ÙŠØ¨ÙŠ</strong></td>
                                <td>{{ payment.payment_method }}</td>
                                <td>{{ payment.received_by }}</td>
                                <td>
                                    <a href="{{ url_for('payment_receipt_v2', order_id=order.id, payment_id=payment.id) }}" 
                                       class="btn btn-sm btn-outline-primary" 
                                       title="Ø·Ø¨Ø§Ø¹Ø© Ø¥ÙŠØµØ§Ù„">
                                        <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                            <tr class="table-active">
                                <td colspan="2"><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</strong></td>
                                <td><strong>{{ "%.2f"|format(order.total_paid) }} Ø¯ÙŠÙ†Ø§Ø± Ù„ÙŠØ¨ÙŠ</strong></td>
                                <td colspan="3"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¯ÙÙˆØ¹Ø§Øª Ù…Ø³Ø¬Ù„Ø©</p>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Ù‚Ø³Ù… Ø§Ù„Ù…ÙˆØ§Ø¯ - Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø£ÙÙ‚ÙŠ Ø§Ù„Ù…Ø®ØªØµØ± -->
        {% if current_user.role != 'Ù…ÙˆØ¸Ù Ø§Ø³ØªÙ‚Ø¨Ø§Ù„' %}
        <div class="card mb-4 border-primary">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-boxes"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ â”‚ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…ÙˆØ§Ø¯
                </h5>
            </div>
            <div class="card-body">
                <!-- Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø£ÙÙ‚ÙŠØ© -->
                <div class="row text-center mb-3">
                    <div class="col-md-4">
                        <div class="p-3 bg-light rounded">
                            <i class="fas fa-bolt fa-2x text-warning mb-2"></i>
                            <h6 class="mb-0">Ø®ØµÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠ</h6>
                            <small class="text-muted">ÙÙˆØ±ÙŠ Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="p-3 bg-light rounded">
                            <i class="fas fa-chart-line fa-2x text-info mb-2"></i>
                            <h6 class="mb-0">ØªØªØ¨Ø¹ Ø§Ù„Ù†Ù‚Øµ</h6>
                            <small class="text-muted">Ø¯Ù‚ÙŠÙ‚ ÙˆÙ…ÙØµÙ„</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="p-3 bg-light rounded">
                            <i class="fas fa-sync-alt fa-2x text-success mb-2"></i>
                            <h6 class="mb-0">Ø¥Ø¯Ø§Ø±Ø© Ø°ÙƒÙŠØ©</h6>
                            <small class="text-muted">Ù„Ù„Ù†Ù‚Øµ ÙˆØ§Ù„Ø¥ÙƒÙ…Ø§Ù„</small>
                        </div>
                    </div>
                </div>
                
                <!-- Ø§Ù„Ø£Ø²Ø±Ø§Ø± -->
                {% if current_user.role in ['Ù…Ø¯ÙŠØ±', 'Ù…Ø³Ø¤ÙˆÙ„ Ù…Ø®Ø²Ù†', 'Ù…Ø³Ø¤ÙˆÙ„ Ø¥Ù†ØªØ§Ø¬', 'Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª'] %}
                <div class="text-center mb-4">
                    <a href="{{ url_for('order_materials', order_id=order.id) }}" class="btn btn-primary btn-lg me-2">
                        <i class="fas fa-boxes"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ Ù„Ù„Ø·Ù„Ø¨ÙŠØ©
                    </a>
                    <a href="{{ url_for('shortage_materials_list') }}" class="btn btn-outline-warning btn-lg">
                        <i class="fas fa-exclamation-triangle"></i> Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù†Ø§Ù‚ØµØ©
                    </a>
                </div>
                {% endif %}
                
                <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ - Ø³Ø¬Ù„ Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ø³Ø§Ø¨Ù‚ -->
                {% if material_consumptions %}
                <hr class="my-3">
                <h6 class="text-muted mb-3">
                    <i class="fas fa-history"></i> Ø³Ø¬Ù„ Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ø³Ø§Ø¨Ù‚:
                </h6>
                <div class="table-responsive">
                    <table class="table table-sm table-hover table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                                <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                <th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                                <th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th>
                                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for consumption in material_consumptions %}
                            <tr>
                                <td><strong>{{ consumption.material.name }}</strong></td>
                                <td>{{ consumption.quantity_used }} {{ consumption.material.unit }}</td>
                                <td>{{ consumption.unit_price }} Ø¯ÙŠÙ†Ø§Ø± Ù„ÙŠØ¨ÙŠ</td>
                                <td><span class="badge bg-secondary">{{ consumption.stage.stage_name }}</span></td>
                                <td>{{ consumption.batch_date }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info text-center mt-3">
                    <i class="fas fa-info-circle"></i>
                    Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø³Ø§Ø¨Ù‚ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø·Ù„Ø¨ÙŠØ©
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙÙ‚ Ø¬Ø¯ÙŠØ¯ -->
{% if current_user.role in ['Ù…Ø¯ÙŠØ±', 'Ù…ÙˆØ¸Ù Ø§Ø³ØªÙ‚Ø¨Ø§Ù„'] %}
<div class="modal fade" id="addDocumentModal" tabindex="-1" aria-labelledby="addDocumentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addDocumentModalLabel">Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙÙ‚ Ø¬Ø¯ÙŠØ¯</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addDocumentForm" method="POST" action="{{ url_for('add_document', order_id=order.id) }}" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="file" class="form-label">Ø§Ø®ØªØ± Ù…Ù„Ù</label>
                        <input type="file" class="form-control" id="file" name="file" required accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt">
                        <div class="form-text">Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø©: Ø§Ù„ØµÙˆØ±ØŒ PDFØŒ WordØŒ ExcelØŒ Ø§Ù„Ù†ØµÙˆØµ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰: 16 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª)</div>
                    </div>
                    
                    {% set deposit_stage = order.stages|selectattr("stage_name", "equalto", "Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ†")|first %}
                    {% if current_user.role == 'Ù…ÙˆØ¸Ù Ø§Ø³ØªÙ‚Ø¨Ø§Ù„' and deposit_stage and deposit_stage.progress == 100 %}
                    <div class="alert alert-warning">
                        <i class="fas fa-lock"></i> Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙÙ‚Ø§Øª Ø¨Ø¹Ø¯ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ†
                    </div>
                    {% endif %}
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                <button type="button" class="btn btn-success" id="saveDocumentBtn">
                    <i class="fas fa-upload"></i> Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Modal Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ† -->
{% if current_user.role in ['Ù…Ø¯ÙŠØ±', 'Ù…ÙˆØ¸Ù Ø§Ø³ØªÙ‚Ø¨Ø§Ù„'] %}
<div class="modal fade" id="receiveDepositModal" tabindex="-1" aria-labelledby="receiveDepositModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="receiveDepositModalLabel">Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ†</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="receiveDepositForm" method="POST" action="{{ url_for('receive_deposit', order_id=order.id) }}">
                    <div class="alert alert-info">
                        <strong>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø·Ù„Ø¨ÙŠØ©:</strong> {{ "%.2f"|format(order.total_value) }} Ø¯ÙŠÙ†Ø§Ø± Ù„ÙŠØ¨ÙŠ<br>
                        <strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</strong> {{ "%.2f"|format(order.remaining_amount) }} Ø¯ÙŠÙ†Ø§Ø± Ù„ÙŠØ¨ÙŠ
                    </div>
                    
                    <div class="mb-3">
                        <label for="deposit_amount" class="form-label">Ù…Ø¨Ù„Øº Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ†</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="deposit_amount" name="deposit_amount" min="1" step="0.01" max="{{ order.total_value }}" required>
                            <span class="input-group-text">Ø¯ÙŠÙ†Ø§Ø± Ù„ÙŠØ¨ÙŠ</span>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="payment_method" class="form-label">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
                        <select class="form-select" id="payment_method" name="payment_method">
                            <option value="Ù†Ù‚Ø¯">Ù†Ù‚Ø¯</option>
                            <option value="Ø¨Ù†Ùƒ">ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ</option>
                            <option value="Ø´ÙŠÙƒ">Ø´ÙŠÙƒ</option>
                            <option value="ÙƒØ§Ø±Øª">Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="payment_notes" class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                        <textarea class="form-control" id="payment_notes" name="payment_notes" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                <button type="button" class="btn btn-success" id="saveDepositBtn">
                    <i class="fas fa-money-bill-wave"></i> Ø§Ø³ØªÙ„Ø§Ù… ÙˆØ¥ØµØ¯Ø§Ø± Ø¥ÙŠØµØ§Ù„
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ù„Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø© -->
<div class="modal fade" id="addPaymentModal" tabindex="-1" aria-labelledby="addPaymentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addPaymentModalLabel">Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addPaymentForm" method="POST" action="{{ url_for('add_payment', order_id=order.id) }}">
                    <div class="alert alert-info">
                        <strong>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø·Ù„Ø¨ÙŠØ©:</strong> {{ "%.2f"|format(order.total_value) }} Ø¯ÙŠÙ†Ø§Ø± Ù„ÙŠØ¨ÙŠ<br>
                        <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª:</strong> {{ "%.2f"|format(order.total_paid) }} Ø¯ÙŠÙ†Ø§Ø± Ù„ÙŠØ¨ÙŠ<br>
                        <strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</strong> {{ "%.2f"|format(order.remaining_amount) }} Ø¯ÙŠÙ†Ø§Ø± Ù„ÙŠØ¨ÙŠ
                    </div>
                    
                    <div class="mb-3">
                        <label for="amount" class="form-label">Ù…Ø¨Ù„Øº Ø§Ù„Ø¯ÙØ¹Ø©</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="amount" name="amount" min="1" step="0.01" max="{{ order.remaining_amount }}" required>
                            <span class="input-group-text">Ø¯ÙŠÙ†Ø§Ø± Ù„ÙŠØ¨ÙŠ</span>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="payment_type" class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹Ø©</label>
                        <select class="form-select" id="payment_type" name="payment_type">
                            <option value="Ø¯ÙØ¹Ø©">Ø¯ÙØ¹Ø©</option>
                            <option value="Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº">Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="payment_method_new" class="form-label">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
                        <select class="form-select" id="payment_method_new" name="payment_method">
                            <option value="Ù†Ù‚Ø¯">Ù†Ù‚Ø¯</option>
                            <option value="Ø¨Ù†Ùƒ">ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ</option>
                            <option value="Ø´ÙŠÙƒ">Ø´ÙŠÙƒ</option>
                            <option value="ÙƒØ§Ø±Øª">Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="payment_notes_new" class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                        <textarea class="form-control" id="payment_notes_new" name="payment_notes" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                <button type="button" class="btn btn-primary" id="savePaymentBtn">
                    <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø©
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Modal Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© - Ù…Ø®ÙÙŠ Ø¹Ù† Ù…ÙˆØ¸Ù Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ -->
{% if current_user.role != 'Ù…ÙˆØ¸Ù Ø§Ø³ØªÙ‚Ø¨Ø§Ù„' %}
<!-- Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù‚Ø¯ÙŠÙ… ØªÙ… Ø­Ø°ÙÙ‡ - Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙŠ /order/<id>/materials -->
{% endif %}

{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // ØªØ¹ÙŠÙŠÙ† ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… ÙƒØ§ÙØªØ±Ø§Ø¶ÙŠ Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ
        $('#batch_date').val(new Date().toISOString().split('T')[0]);

        // Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
        $('#material_id').change(function() {
            var materialId = $(this).val();
            if (materialId) {
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© Ù„Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
                $.ajax({
                    url: '/api/material/' + materialId + '/price',
                    type: 'GET',
                    success: function(response) {
                        if (response.success) {
                            $('#unit_price').val(response.unit_price);
                        }
                    },
                    error: function() {
                        console.log('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø³Ø¹Ø± Ø§Ù„Ù…Ø§Ø¯Ø©');
                    }
                });
            }
        });

        // Ø¹Ù†Ø¯ Ø­ÙØ¸ Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ù„ÙƒØ©
        $('#saveMaterialBtn').click(function() {
            $('#addMaterialForm').submit();
        });
        
        // Ù…Ø¹Ø§Ù„Ø¬ Ù„Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
        $('#saveDocumentBtn').click(function() {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù
            const fileInput = $('#file')[0];
            if (!fileInput.files.length) {
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù (16 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª = 16 * 1024 * 1024 Ø¨Ø§ÙŠØª)
            const maxSize = 16 * 1024 * 1024;
            if (fileInput.files[0].size > maxSize) {
                alert('Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ø§Ù„Ù…Ø³Ù…ÙˆØ­: 16 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª');
                return;
            }
            
            $('#addDocumentForm').submit();
        });
        
        // Ø¥Ø¸Ù‡Ø§Ø± ØªÙ‚Ø¯Ù… Ø§Ù„Ø±ÙØ¹
        $('#addDocumentForm').submit(function() {
            $('#saveDocumentBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...');
        });
        
        // Ù…Ø¹Ø§Ù„Ø¬ Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ†
        $('#saveDepositBtn').click(function() {
            const amount = parseFloat($('#deposit_amount').val());
            const maxAmount = parseFloat('{{ order.total_value }}');
            
            if (!amount || amount <= 0) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ†');
                return;
            }
            
            if (amount > maxAmount) {
                alert('Ù…Ø¨Ù„Øº Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ† Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† Ù‚ÙŠÙ…Ø© Ø§Ù„Ø·Ù„Ø¨ÙŠØ©');
                return;
            }
            
            if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªÙ„Ø§Ù… Ø¹Ø±Ø¨ÙˆÙ† Ø¨Ù‚ÙŠÙ…Ø© ${amount} Ø¯ÙŠÙ†Ø§Ø± Ù„ÙŠØ¨ÙŠØŸ Ø³ÙŠØªÙ… Ø¥ØµØ¯Ø§Ø± Ø¥ÙŠØµØ§Ù„ Ù‚Ø¨Ø¶.`)) {
                $('#receiveDepositForm').submit();
            }
        });
        
        // Ù…Ø¹Ø§Ù„Ø¬ Ù„Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©
        $('#savePaymentBtn').click(function() {
            const amount = parseFloat($('#amount').val());
            const maxAmount = parseFloat('{{ order.remaining_amount }}');
            
            if (!amount || amount <= 0) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº Ø§Ù„Ø¯ÙØ¹Ø©');
                return;
            }
            
            if (amount > maxAmount) {
                alert('Ù…Ø¨Ù„Øº Ø§Ù„Ø¯ÙØ¹Ø© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ');
                return;
            }
            
            $('#addPaymentForm').submit();
        });
        
        // ØªØ­Ø¯ÙŠØ« Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒØ§Ù…Ù„
        $('#amount').on('input', function() {
            const amount = parseFloat($(this).val());
            const remainingAmount = parseFloat('{{ order.remaining_amount }}');
            
            if (amount === remainingAmount) {
                $('#payment_type').val('Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº');
            } else {
                $('#payment_type').val('Ø¯ÙØ¹Ø©');
            }
        });
    });

    // ÙØªØ­ PDF ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ†
    $(document).ready(function() {
        const urlParams = new URLSearchParams(window.location.search);
        const receiptFile = urlParams.get('print_receipt');
        
        if (receiptFile) {
            // ÙØªØ­ PDF ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©
            const pdfUrl = "{{ url_for('download_receipt', filename='PLACEHOLDER') }}".replace('PLACEHOLDER', receiptFile);
            window.open(pdfUrl, '_blank');
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¹Ø§Ù…Ù„ Ù…Ù† URL Ù„ØªØ¬Ù†Ø¨ ÙØªØ­ PDF Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«
            const newUrl = window.location.origin + window.location.pathname;
            window.history.replaceState({}, document.title, newUrl);
        }
    });
</script>
{% endblock %}
# خطة فصل الصالات وإدارة الموردين والتسعير

## الهدف العام
- عزل صلاحيات موظفي الاستقبال حسب الصالة (Showroom)
- فصل البيانات التشغيلية والمالية لكل صالة (multi-tenant style)
- إضافة نظام مورّدين وفواتير شراء مع دفعات وديون
- بناء سياسة تسعير تكلفة مرنة (سعر شراء افتراضي، متوسط مرجّح، آخر فاتورة)
- تمكين إعدادات مركزية من أدوات المشرف للتحكم في سلوك التسعير وإمكانية التعديل

---

## الجزء الأول: فصل الصالات (Showrooms)

### نماذج جديدة/تعديلات
- Showroom
  - id, name, address, notes, is_active
- User (تعديل)
  - add: showroom_id (Nullable للمديرين العامين)
  - add: role_scopes (اختياري JSON للأدوار المركّبة مستقبلًا)
- Order, Material, Stage, Document, Payment, OrderCost, MaterialConsumption
  - add: showroom_id (NOT NULL) مع فهرس

### منطق الوصول (Authorization)
- الموظف بدور "موظف استقبال" مرتبط بـ `showroom_id` واحد:
  - يستطيع CRUD على: العملاء، الطلبات، المدفوعات، المرفقات ضمن صالته فقط
  - تصفية جميع الاستعلامات بـ `filter_by(showroom_id=current_user.showroom_id)`
- المدير العام (role='مدير')
  - يستطيع اختيار صالة من قائمة filter في الواجهة لعرض/إدارة بياناتها
  - أو وضع "all" لعرض جميع الصالات (مع تحذير أداء)

### هجرة البيانات (Migration)
- إضافة عمود showroom_id إلى الجداول الأساسية مع default مؤقت
- إنشاء جدول Showroom وملء صالة افتراضية واحدة
- إسناد كل السجلات الحالية للصالة الافتراضية

### تحسينات منطق
- إضافة فلتر واجهة أعلى كل صفحة بيانات: [الصالـة]
- إضافة قيود قاعدة البيانات (composite unique) إن لزم مثل: unique(customer.name, phone, showroom_id)

---

## الجزء الثاني: إدارة المورّدين والفواتير

### نماذج جديدة
- Supplier
  - id, name, phone, email, address, tax_id, notes, is_active, showroom_id
- PurchaseInvoice
  - id, supplier_id, showroom_id, invoice_number, invoice_date, due_date,
    total_amount, paid_amount, remaining_amount (computed), status (open/partial/paid/overdue), notes
- PurchaseInvoiceItem
  - id, invoice_id, material_id, quantity, purchase_price (سعر الشراء للوحدة),
    line_total (quantity*purchase_price)
- SupplierPayment
  - id, supplier_id, invoice_id (nullable للدفع العام)، amount, method, date, notes, received_by

### تدفق العمل
1) إنشاء فاتورة شراء + عناصرها
2) تحديث مخزون المواد:
   - زيادة `Material.quantity_available += quantity`
   - تحديث `Material.unit_price` (سعر التكلفة) وفق سياسة التسعير المُختارة (انظر الجزء الثالث)
3) تسجيل دفعات الموردين، حساب المتبقي، حالات الفاتورة

### قيود واتساق
- كل سجل مرتبط بـ `showroom_id`
- منع حذف فاتورة مدفوعة/جزئيًا بدون عكس أثر المخزون
- فهارس: (supplier_id), (invoice_date), (showroom_id)

---

## الجزء الثالث: سياسة تسعير التكلفة

### سياسات مدعومة
- CostPriceMode = { purchase_price_default, weighted_average, last_invoice }
- إعداد افتراضي على مستوى النظام: Tools → Admin Settings
- يمكن override على مستوى مادة محددة (Material) أو على مستوى الصالة

### منطق الحساب
- purchase_price_default:
  - `material.cost_price = last_purchase_price`
- weighted_average (متوسط مرجّح لكل صنف):
  - `new_cost = (old_cost*old_qty + purchase_price*new_qty) / (old_qty + new_qty)`
- last_invoice:
  - `material.cost_price = last_purchase_price`

### عناصر التحكم في أدوات المشرف
- Checkbox: "السماح بتغيير سعر التكلفة يدويًا" (per-role toggle)
- اختيار السياسة الافتراضية: [افتراضي الشراء] [متوسط مرجّح] [آخر فاتورة]
- شاشة لإدارة الأصناف: تحديد أصناف تعتمد سياسة مختلفة عن الافتراضي

---

## الجزء الرابع: صلاحيات وأذونات

- تعريف أدوار: [مدير، موظف استقبال، مسؤول مخزن، مسؤول إنتاج، مسؤول العمليات]
- مصفوفة صلاحيات لكل دور مع نطاق صالة:
  - Reception: Orders/Payments/Documents ضمن الصالة فقط
  - Warehouse: Materials/Stock ضمن الصالة فقط
  - Manager: جميع الصالات + إعدادات
- تطبيق عبر Decorators/Policies:
  - `@require_showroom` يضمن تمرير showroom_id
  - توحيد فلاتر ORM في Helper: `scoped_query(model)` ترجع Query مصفّاة حسب الصلاحيات

---

## الجزء الخامس: تعديلات قاعدة البيانات المقترحة (DDL)

- إضافة `showroom_id` إلى الجداول: users (nullable), customers, orders, materials, stages, documents,
  order_costs, payments, material_consumptions
- إنشاء الجداول الجديدة: suppliers, purchase_invoices, purchase_invoice_items, supplier_payments
- فهارس مركبة لتحسين الأداء: (showroom_id, created_at) حيث يلزم

---

## الجزء السادس: واجهات المستخدم (UI/UX)

- شريط علوي يحتوي Selector للصالة الحالية (للمدير والمستخدمين الذين لديهم أكثر من صالة)
- صفحات الموردين:
  - قائمة الموردين + بحث
  - فاتورة شراء: رأس الفاتورة + جدول الأصناف + إجماليات + دفعات
  - صفحة دفعات الموردين: تسجيل دفعة، عرض المتبقي
- صفحة إعدادات أدوات المشرف:
  - سياسات التسعير
  - التحكم بإمكانية تعديل تكلفة المواد
  - شاشة إدارة سياسة كل صنف (قائمة المواد مع عمود سياسة التكلفة)

---

## الجزء السابع: خطة الترحيل والتنفيذ

1) Migration 1: إنشاء جدول Showroom + إضافة showroom_id للجداول + إسناد البيانات الحالية لصالة افتراضية
2) Migration 2: إنشاء جداول الموردين والفواتير والدفعات
3) Layer التطبيق:
   - إضافة Middleware/Helpers لفصل الاستعلامات حسب showroom_id
   - تحديث جميع المسارات بإضافة/تصفية showroom_id
   - حماية الواجهات حسب الدور والصالة
4) UI: إضافة Selector للصالة + شاشات الموردين + إعدادات المشرف
5) اختبارات تكامل: عمليات
   - إنشاء طلب/فاتورة/دفعة عبر صالات مختلفة للتأكد من العزل

---

## تحسينات منطق مقترحة
- Audit Log: سجل تغييرات على الأسعار والمخزون مع user_id وtimestamp
- Soft Delete للمواد والفواتير مع حقل is_active بدل الحذف الفيزيائي
- تنبيهات انخفاض المخزون per-showroom
- تقارير:
  - ربحية حسب الصالة
  - دوران المخزون حسب الصالة
  - التزامات الموردين (أعمار الديون)
- Webhooks/Exports: تصدير CSV/PDF للفواتير والمخزون

---

## ملخص سريع للتطبيق
- إضافة كيان Showroom وربط كل البيانات به
- تصفية الاستعلامات والصلاحيات حسب الصالة
- إضافة منظومة الموردين والفواتير والدفعات
- سياسة تسعير قابلة للتهيئة (افتراضي/متوسط/آخر فاتورة)
- إعدادات مركزية عبر أدوات المشرف للتحكم في التسعير وإمكانية تعديل التكلفة

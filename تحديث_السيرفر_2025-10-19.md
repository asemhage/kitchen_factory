# 🚀 أوامر تحديث السيرفر - 2025-10-19

## 📋 ملخص التحديث
تحديث شامل للصلاحيات ونقل إدخال الأمتار

---

## 🔧 الطريقة الأولى: استخدام سكريبت التحديث التلقائي

### 1️⃣ تشغيل السكريبت (موجود مسبقاً):
```bash
cd ~
./redeploy_from_github.sh
```

**هذا السكريبت سيقوم تلقائياً بـ:**
- ✅ إيقاف التطبيق
- ✅ عمل نسخة احتياطية من قاعدة البيانات
- ✅ تنزيل آخر التحديثات من GitHub
- ✅ استعادة قاعدة البيانات
- ✅ إعادة تشغيل التطبيق

---

## 🔧 الطريقة الثانية: التحديث اليدوي (خطوة بخطوة)

### 1️⃣ الاتصال بالسيرفر:
```bash
ssh asem@102.213.180.235
```

### 2️⃣ إيقاف التطبيق:
```bash
# محاولة إيقاف الخدمة (إن وجدت)
sudo systemctl stop kitchen_factory.service 2>/dev/null || true

# أو إيقاف العملية يدوياً
pkill -f "python.*app.py"
```

### 3️⃣ عمل نسخة احتياطية:
```bash
cd ~/kitchen_factory
BACKUP_FILE="backup_$(date +%Y%m%d_%H%M%S).db"
cp instance/kitchen_factory.db "instance/$BACKUP_FILE"
echo "✅ تم إنشاء نسخة احتياطية: $BACKUP_FILE"
```

### 4️⃣ تنزيل التحديثات من GitHub:
```bash
cd ~/kitchen_factory
git fetch origin
git pull origin main
```

### 5️⃣ التحقق من التحديثات:
```bash
git log -1 --oneline
```
يجب أن ترى الرسالة:
```
e1d68e0 تحديث شامل: إعادة هيكلة الصلاحيات ونقل إدخال الأمتار...
```

### 6️⃣ تفعيل البيئة الافتراضية:
```bash
source venv/bin/activate
```

### 7️⃣ إعادة تشغيل التطبيق:

**أ) إذا كان لديك systemd service:**
```bash
sudo systemctl start kitchen_factory.service
sudo systemctl status kitchen_factory.service
```

**ب) أو التشغيل اليدوي:**
```bash
nohup python app.py > app.log 2>&1 &
echo "✅ تم تشغيل التطبيق - PID: $!"
```

### 8️⃣ التحقق من التشغيل:
```bash
# التحقق من العملية
ps aux | grep "python.*app.py"

# التحقق من اللوج
tail -f app.log

# أو لوج النظام
tail -f nohup.out
```

### 9️⃣ اختبار التطبيق:
```bash
curl http://102.213.180.235:4012
```
أو افتح المتصفح على: `http://102.213.180.235:4012`

---

## 🔍 أوامر التحقق والمراقبة

### التحقق من الملفات المحدثة:
```bash
cd ~/kitchen_factory
git diff HEAD~1 --name-only
```

### عرض التغييرات:
```bash
git show HEAD --stat
```

### مراقبة اللوج المباشر:
```bash
tail -f ~/kitchen_factory/app.log
# أو
tail -f ~/kitchen_factory/nohup.out
```

### التحقق من البورت:
```bash
netstat -tulnp | grep 4012
# أو
lsof -i :4012
```

---

## 🆘 في حالة وجود مشاكل

### استعادة النسخة الاحتياطية:
```bash
cd ~/kitchen_factory/instance
# عرض النسخ الاحتياطية
ls -lh backup_*.db

# استعادة نسخة معينة
cp backup_YYYYMMDD_HHMMSS.db kitchen_factory.db

# إعادة تشغيل التطبيق
cd ~/kitchen_factory
nohup python app.py > app.log 2>&1 &
```

### الرجوع للإصدار السابق:
```bash
cd ~/kitchen_factory
git log --oneline -5  # عرض آخر 5 commits
git reset --hard df226f0  # الرجوع للإصدار السابق
nohup python app.py > app.log 2>&1 &
```

---

## 📊 ما الذي تم تحديثه؟

### ✅ الملفات المعدلة:
1. `Change log.md` - توثيق التحديثات
2. `kitchen_factory/app.py` - تحديث الصلاحيات ومنطق الأمتار
3. `kitchen_factory/templates/edit_user.html` - منطق الصالة
4. `kitchen_factory/templates/new_order.html` - إزالة حقل الأمتار
5. `kitchen_factory/templates/new_user.html` - منطق الصالة
6. `kitchen_factory/templates/order_stages.html` - إضافة حقل الأمتار

### ✅ الميزات الجديدة:
- إلغاء ربط الأدوار الإدارية بالصالات
- فصل صلاحيات المواد/الموردين/الفواتير
- نقل إدخال الأمتار لمرحلة حصر المتطلبات
- صلاحيات مسؤول المخزن: المواد + الموردين + الفواتير فقط
- صلاحيات مسؤول الإنتاج: حصر المتطلبات + المراحل + الأمتار
- صلاحيات مسؤول العمليات: كل الصلاحيات السابقة

---

## ⚠️ ملاحظات هامة

1. **قاعدة البيانات:** لا تحتاج إلى migration جديد، التحديثات فقط في الكود
2. **الصلاحيات:** تأكد من اختبار الصلاحيات الجديدة لكل دور
3. **النسخ الاحتياطية:** يتم إنشاؤها تلقائياً قبل كل تحديث
4. **المستخدمين الحاليين:** لن تتأثر بياناتهم، فقط الصلاحيات

---

## 📞 للدعم

إذا واجهت أي مشكلة، أرسل لوج الأخطاء:
```bash
tail -100 ~/kitchen_factory/app.log
```

---

✅ **آخر تحديث:** 2025-10-19
🔗 **Commit:** e1d68e0
📦 **الملفات المعدلة:** 13 ملف

